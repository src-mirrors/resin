<?php
/**
 * Custom meters
 */

require_once "WEB-INF/php/inc.php";

$javascript = <<<EOF
  $("#meter-tabs").tabs().find(".ui-tabs-nav").sortable({axis:'x'});
EOF;

if (! admin_init()) {
  return;
}

$server = $g_mbean_server->lookup("resin:type=Server");
$stat_service = $g_mbean_server->lookup("resin:type=StatService");

$stat_service = $g_mbean_server->lookup("resin:type=StatService");
$si = sprintf("%02d", $server->SelfServer->ClusterIndex);

if (! $stat_service) {
  echo "<p>Meters requires Resin Professional and a valid license.</p>";
  return;
}

$pages = $stat_service->getMeterGraphPages();

usort($pages, "page_name_compare");

display_tabs($pages);

function page_name_compare($a, $b)
{
  return strcmp($a->name, $b->name);
}

function display_tabs($pages)
{
  echo "<div id='meter-tabs'>";
  echo "<ul>";

  foreach ($pages as $page) {
    $name = $page->name;
    
    $tab_name = $name . "-tab";

    echo "<li><a href='#${tab_name}'>$name</a></li>\n";
  }

  echo "<li><a href='#new_meter-tab'>+</a></li>\n";
  echo "</ul>\n";

  foreach ($pages as $page) {
    $tab_name = $page->name . "-tab";

    echo "<div id='${tab_name}'>\n";

    meter_display_page($page);

    echo "</div>";
  }

  echo "<div id='new_meter-tab'>\n";
  echo "</div>";

  echo "</div>\n";
}

function meter_display_page($page)
{
  global $g_mbean_server;
  global $g_periods;
  
  $stat_service = $g_mbean_server->lookup("resin:type=StatService");

  if (! $stat_service)
    return;

  $si = sprintf("%02d", $g_server->Index);

  $page_name = "pg_" . $page->name;
  $count = 0;

  $period_ms = $page->period;
  if ($period_ms <= 0) {
    $period_ms = (6 * 60 * 60 * 1000);
  }
  
  $period = ($period_ms / 1000);
  
  $end = time();

  $columns = $page->columns;
  $graph_count = count($page->meterGraphs);

  if ($columns > 0) {
  }
  else if ($graph_count > 9) {
    $columns = 4;
  }
  else if ($graph_count > 4) {
    $columns = 3;
  }
  else if ($graph_count > 1) {
    $columns = 2;
  }
  else {
    $columns = 1;
  }

  $width = 800 / $columns;
  $height = $width * 0.66;

  $is_column = false;
  
  echo "  <div style='text-align:center;display:inline-block;width:800px;'>\n";
	echo "   <div style='float:left;font-size:1.5em;text-align:left;margin-bottom:.5em;'>" . $page->getName() . "</div>\n";
	echo "   <div style='float:right;font-size:1em;text-align:right;margin-bottom:.5em;vertical-align:middle;'>\n";
	echo "    <label for='summary-control-time'>Period</label>: <select name='summary-control-time' id='summary-control-time'>\n";
	
	foreach ($g_periods as $select_period => $name) {
		echo "     <option value='${select_period}'";
		if ($period == $select_period) {
			echo "selected='selected'";
		}
		echo ">${name}</option>\n";
	}
	
	echo "    </select> \n";
	echo "   </div>\n";
	echo "  </div>\n";
	
  echo "<script language='javascript' type='text/javascript'>\n";
  echo "<!-- \n";
  echo "$(function () {\n";
	echo "	$(\"#summary-control-time\").change(function () {\n";
  echo "		period = $(this).val();\n";
  echo "		if (period > 0) {\n";
  echo "	    $('div[id$=\"-thumb-plot\"]').each(function () {\n";
  echo "				$(this).trigger(\"changeperiod\", period);\n";
  echo "			});\n";
  echo "		}\n"
  echo "	});\n"
  echo "});\n"
  echo " -->\n";
  echo "</script>\n\n"; 
         
  echo "<table border='0'>\n";

  foreach ($page->meterGraphs as $graph) {
    $graph_name = $page_name . "_" . $count;

    if ($count % $columns == 0) {
      if ($is_column)
        echo "</tr>";
        
      echo "<tr>";

      $is_column = true;
    }

    if ($graph) {
      echo "<td valign='top'>";
      meter_display_graph($graph_name, $graph, $width, $height, $end, $period);
      echo "</td>";
    }

    $count++;
  }

  if ($is_column)
    echo "</tr>";
    
  echo "</table>";
}  

function meter_display_graph($name, $graph, $width, $height, $end, $period)
{
//  echo " <div style='float:top;padding:.5em;'>\n"
  
  $si = sprintf("%02d", $g_server->Index);

  $meters = array();

  if ($graph->name)
    $caption = $graph->name;

  foreach ($graph->meterNames as $meter_name) {
    $full_name = $si . "|" . $meter_name;

    $meters[] = $full_name;

    if (! $caption)
      $caption = $full_name;
  }

  if (! $caption)
    $caption = $name;

  stat_graph($name, $width, $height, $end, $period, $meters,
             "A line graph representing $caption over the last 6 hours.",
             'bottom', null, null, $caption);
               
//  echo " </div>\n";
}

display_footer($g_page, $javascript);

?>
