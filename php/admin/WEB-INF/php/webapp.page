<?php

require_once "WEB-INF/php/inc.php";

if (! admin_init()) {
  return;
}

$webapp = $g_mbean_server->lookup($_GET['id']);

$request = quercus_servlet_request();
$is_secure = $request->isSecure();
$user = quercus_get_request()->getUserPrincipal();
$client = @new Java("com.caucho.server.admin.WebAppDeployClient");

if ($is_secure) {
  $action = $_POST['action'];

  if ($action == "start") {
    $mbean = $g_mbean_server->lookup($_POST['name']);
    $mbean->start();
  }
  elseif ($action == "stop") {
    $mbean = $g_mbean_server->lookup($_POST['name']);
    $mbean->stop();
  }
  elseif ($action == "restart") {
    $mbean = $g_mbean_server->lookup($_POST['name']);
    $mbean->restart();
  }
  elseif ($action == 'update') {
    $path = $_FILES['application']['tmp_name'];

    $commit = process_deploy_args();

    $client->commitArchive($commit, $path);
  }
  elseif ($action == 'deploy') {
    $path = $_FILES['application']['tmp_name'];

    $commit = process_deploy_args();

    $client->commitArchive($commit, $path);
  }
}

if ($webapp) {
  display_webapp_page($g_mbean_server, $webapp);
}
else {
  display_webapp_summary_page($g_mbean_server);
}

/**
 * single-page webapp
 */
function display_webapp_page($mbean_server, $webapp)
{
  global $is_secure;

  $session = $webapp->SessionManager;
  
  echo <<<END
<h2>WebApp</h2>

<table class="data">
  <tr>
    <th>Web-App</th>
    <th>State</th>
    <th>Active</th>
    <th>Sessions</th>
    <th>Uptime</th>
    <th colspan='2'>500</th>
  </tr>
END;

  echo "<tr class='" . row_style($count++) . "'>\n";
  echo " <td class='item'>\n";

  $context_path = empty($webapp->ContextPath) ? "/" : $webapp->ContextPath;

  echo $context_path;

  echo " </td>";

  echo "  <td class='" . format_state_class($webapp->State) . "'>\n";
  echo  $webapp->State;
  echo "  </td>\n";
  echo "  <td>" . $webapp->RequestCount . "</td>\n";
  echo "  <td>" . $session->SessionActiveCount . "</td>\n";
  echo "  <td class='" . format_ago_class($webapp->StartTime) . "'>\n";
  echo "    " . format_ago($webapp->StartTime) . "\n";
  echo "   </td>\n";

        format_ago_td_pair($webapp->Status500CountTotal,
                           $webapp->Status500LastTime);

  echo "</tr>\n";
  echo "</table>";

  echo "<h3>Actions</h3>\n";

  if ($is_secure) {
    $disabled = "";
  }
  else {
    $disabled = "disabled='true'";
    echo "<div class='warn'>Actions can only be performed over a secure connection (SSL)</div>";
  }

  $name = $webapp->mbean_name;

  echo "<form method='POST' style='display:inline'>\n";
  echo "<input type='hidden' name='action' value='start'>\n";
  echo "<input type='hidden' name='name' value='$name'>\n";
  if ($webapp->State == "ACTIVE")
    echo "<input type='submit' name='submit' value='start' disabled='true'>\n";
  else
    echo "<input type='submit' name='submit' value='start' $disabled>\n";
  echo "</form>";

  echo "<form method='POST' style='display:inline'>\n";
  echo "<input type='hidden' name='action' value='stop'>\n";
  echo "<input type='hidden' name='name' value='$name'>\n";
  if ($webapp->State == "ACTIVE")
    echo "<input type='submit' name='submit' value='stop' $disabled>\n";
  else
    echo "<input type='submit' name='submit' value='stop' disabled='true'>\n";
  echo "</form>";

  echo "<form method='POST' style='display:inline'>";
  echo "<input type='hidden' name='action' value='restart'>";
  echo "<input type='hidden' name='name' value='$name'>\n";
  if ($webapp->State == "ACTIVE")
    echo "<input type='submit' name='submit' value='restart' disabled='true'>\n";
  else
    echo "<input type='submit' name='submit' value='restart' $disabled>";
  echo "</form>";

  echo "<h2>MBeans</h2>\n";

  $exp = mbean_explode($name);
  $beans = $mbean_server->query("resin:*,Host=" . $exp['Host']
                                 . ",WebApp=" . $exp['name']);

  display_jmx($mbean_server, $beans);
}

function display_tab($name, $un_name, $is_selected)
{
  echo "<li id='tab_" . $name . "' class='";
  
  if ($is_selected) {
    echo "selected";
  } 
 
  echo "'><a href='#' onclick=\"";
  echo "sel('tab_" . $name . "');";
  echo "show('g_" . $name . "');";
  
  echo "unsel('tab_" . $un_name . "');";
  echo "hide('g_" . $un_name . "');";

  echo "\">" . $name . "</a></li>\n";
}

/**
 * summary of all the webapps
 */
function display_webapp_summary_page($g_mbean_server)
{
  echo "<div id='webapp-tabs' style='display: none'>\n";
  echo "<ul>\n";
  echo "<li><a href='#webapp-active'>Active</a></li>\n";
  echo "<li><a href='#webapp-idle'>Idle</a></li>\n";
  echo "<li><a href='#webapp-deploy'>Deploy</a></li>\n";
  echo "</ul>\n";

  echo "<div id='webapp-active'>\n";
  display_webapp_summary($g_mbean_server, false);
  echo "</div>\n";
  
  echo "<div id='webapp-idle'>\n";
  display_webapp_summary($g_mbean_server, true);
  echo "</div>\n";

  echo "<div id='webapp-deploy'>\n";
  display_deploy_form($g_mbean_server);
  echo "</div>\n";
  
  echo "</div>\n";
}  

/**
 * summary of all the webapps
 */
function display_webapp_summary($g_mbean_server, $is_idle)
{
  global $is_secure;
  
?>

<!-- Applications -->
<h2>WebApps</h2>

<table class="data">
  <tr>
    <th></th>
    <th>Web-App</th>
    <th>State</th>
    <th>Active</th>
    <th>Sessions</th>
    <th>Uptime</th>
    <th colspan='2'>500</th>
    <th>Deploy</th>
  </tr>
<?php

  if ($g_mbean_server) {
    $hosts = $g_mbean_server->query("resin:*,type=Host");
  }

  $webapp_id = 0;

  usort($hosts, "sort_host");

  foreach ($hosts as $host) {
    $hostName = empty($host->HostName) ? "default" : $host->HostName;

    echo "<tr title='<?= $hostObjectName ?>'><td class='group' colspan='9'>\n";
    echo $host->URL;
    echo "</td></tr>\n";

    $webapps = $host->WebApps;

    usort($webapps, "sort_webapp");
    $count = 0;
    foreach ($webapps as $webapp) {
      if ($is_idle != ($webapp->State == "STOPPED_IDLE")) {
        continue;
      }

      $webapp_name = $webapp->mbean_name;
      $webapp_id++;

      $id = "sw_webapp_" . ($is_idle ? "idle" : "") . $webapp_id;

      echo "<tr class='" . row_style($count++) . "'>";
      echo "<td><span id='${id}' class='switch'></td>\n";

      $is_deploy_valid = true;
      display_webapp($webapp, $is_deploy_valid);
  
      echo "</tr>\n";
      
      echo "<tr class='toggle-${id}'>";
      echo "<td>&nbsp;</td><td colspan='8'>";

      display_webapp_expanded($webapp, $webapp_id, $is_deploy_valid);
      
      echo "</tr>\n";
    }
  }

  echo "</table>\n";
}

function display_webapp($webapp, &$is_deploy_valid)
{
  $session = $webapp->SessionManager;
  $context_path = empty($webapp->ContextPath) ? "/" : $webapp->ContextPath;

  if ($webApp->RepositoryTag) {
    $context_path .= "<br/>&nbsp;&nbsp;(tag: {$webapp->RepositoryTag})";
  }

  $object_name = $webapp->mbean_name;

  echo "<td class='item'>";
  echo $context_path;
  echo "</td>";
  
  echo "<td>";

  if ($webapp->State == "ACTIVE") {
    print_ok("");
    echo " ACTIVE";
  }
  else if ($webapp->State == "FAILED") {
    print_fail(" FAILED");
    $is_deploy_valid = false;
  }
  else {
    echo "&nbsp;" . $webapp->State;
  }
  
  echo "</td>\n";
  ?>
    </td>
    <td><?= $webapp->RequestCount ?></td>
    <td><?= $session->SessionActiveCount ?></td>
    <td class='<?= format_ago_class($webapp->StartTime) ?>'>
      <?= format_ago($webapp->StartTime) ?>
    </td>
    <?php
        format_ago_td_pair($webapp->Status500CountTotal,
                           $webapp->Status500LastTime);

    echo "<td>";

    $deploy = validate_version($webapp);
    
    if ($deploy["version"])
      $version = $deploy["version"];
    else
      $version = $deploy["date"];

    if (! $deploy) {
      $is_deploy_valid = false;
    }
    else if ($deploy["status"] == "OK") {
      print_ok("");
      
      echo " $version";
    }
    else {
      $is_deploy_valid = false;

      print_fail(" $version");
    }
    
    echo "</td>";
}

function validate_version($webapp)
{
  global $g_mbean_server;
  global $g_server;

  $repository = $webapp->getRepositoryMetaData();

  if (! $repository || ! $repository["root"]) {
    return null;
  }
  else {
    $status = "OK";
    $hash = $repository["root"];

    foreach ($g_server->SelfServer->Cluster->Servers as $s) {
      $mbean_server = new MBeanServer($s->Name);
      $s_webapp = $mbean_server->lookup($webapp->mbean_name);

      if (! $s_webapp) {
        $status = "FAIL";
        continue;
      }
      
      $s_repository = $s_webapp->getRepositoryMetaData();

      if ($s_repository["root"] != $repository["root"]) {
        $status = "FAIL";
      }
    }
    
    return array(status => $status,
                 hash => $repository["root"],
                 version => $repository["version"],
                 date => $repository["date"]);
  }
}

function display_webapp_expanded($webapp, $webapp_id, $is_deploy_valid)
{
  global $g_mbean_server;
  global $g_server;

  if ($webapp->ErrorMessage) {
    echo "<div class='warn'>";
    echo htmlspecialchars($webapp->ErrorMessage);
    echo "</div>";
  }

  display_versions($webapp, $webapp_id, $is_deploy_valid);

  $exp = mbean_explode($webapp->mbean_name);
  $query = "resin:*,Host=" . $exp['Host'] . ",WebApp=" . $exp['name'];
  $beans = $g_mbean_server->query($query);

  array_push($beans, $webapp);

  echo "<div class='application-jmx'>";
  echo "<h3>Application MBeans</h3>";
  display_jmx($g_mbean_server, $beans);
  echo "</div>";

  echo "<p>";
  display_webapp_expanded_actions($webapp, $beans, $refresh_id);
}

function display_webapp_expanded_actions($webapp, $beans, $refresh_id)
{
  global $g_server;
  global $is_secure;

  if ($is_secure) {
    $disabled = "";
  }
  else {
    $disabled = "disabled='true'";
    echo "<div class='warn'>Actions can only be performed over a secure connection (SSL)</div>";
  }

  $name = htmlspecialchars($webapp->mbean_name);

  $server_name = $g_server->SelfServer->Name;
  if (! $server_name)
    $server_name = "default";

  echo "<div class='manage-application'>";
  echo "<h3>Manage Application</h3>";
  printf("<b>%02d - %s:</b> ", $g_server->SelfServer->ClusterIndex, $server_name);

  echo "<form method='POST' style='display:inline'>\n";
  echo "<input type='hidden' name='action' value='start'>\n";
  echo "<input type='hidden' name='name' value='$name'>\n";
  if ($webapp->State == "ACTIVE")
    echo "<input type='submit' name='submit' value='start' disabled='true'>\n";
  else
    echo "<input type='submit' name='submit' value='start' $disabled>\n";
  echo "</form>";

  echo "<form method='POST' style='display:inline'>\n";
  echo "<input type='hidden' name='action' value='stop'>\n";
  echo "<input type='hidden' name='name' value='$name'>\n";
  if ($webapp->State == "ACTIVE")
    echo "<input type='submit' name='submit' value='stop' $disabled>\n";
  else
    echo "<input type='submit' name='submit' value='stop' disabled='true'>\n";
  echo "</form>";

  echo "<form method='POST' style='display:inline'>";
  echo "<input type='hidden' name='action' value='restart'>";
  echo "<input type='hidden' name='name' value='$name'>\n";
  if ($webapp->State == "ACTIVE")
    echo "<input type='submit' name='submit' value='restart' $disabled>";
  else
    echo "<input type='submit' name='submit' value='restart' disabled='true'>\n";
  echo "</form>";
  echo "</div>";

  echo "<div class='update-application'>";
  echo "<h3>Update</h3>";
  echo "<form method='POST'>";
  echo "<input type='hidden' name='stage' value='{$g_server->Stage}'>";
  echo "<input type='hidden' name='host' value='{$webapp->Host->Name}'>";
  echo "<input type='hidden' name='action' value='update'>";
  echo "<input type='hidden' name='name' value='{$webapp->ContextPath}'>\n";

  echo "<h4>Commit message</h4>";
  echo "<textarea name='commit-message'></textarea>\n";
  echo "<h4>Version</h4>";

  echo "<input type='number' min='0' size='3' name='version-major' title='Major Version Number' value='0' class='required'>\n";
  echo "<input type='number' min='0' size='3' name='version-minor' title='Minor Version Number' value='0' class='required'>\n";
  echo "<input type='number' min='0' size='3' name='version-micro' title='Micro Version Number' value='0' class='required'>\n";
  echo "<input type='text' name='version-qualifier' title='Version Qualifier (free form)' value=''>\n";

  echo "<h4>Application archive file</h4>";
  echo "<input type='file' name='application'>\n";
  echo "<div style='text-align: right'>";
  echo "<input type='submit' name='submit' value='update' $disabled>";
  echo "</div>";
  echo "</form>";
  echo "</div>";
}

function display_versions($webapp, $webapp_id, $is_deploy_valid)
{
  global $g_server;

  $repository = $webapp->getRepositoryMetaData();

  if (! $repository || ! $repository["root"]) {
    return;
  }

  echo "<table>";
  echo "<tr><td>";
  echo "<span id='sw_deploy_${webapp_id}' class='switch'></span>\n";
  echo "</td>\n";
  echo "<th>Deploy</th>";
  echo "<th>";

  $root = $repository["root"];

  if ($repository["version"])
    $msg = $repository["version"];
  else
    $msg = $repository["date"];

  if ($is_deploy_valid)
    print_ok($msg);
  else
    print_fail($msg);

  echo "</th></tr>\n";

  foreach ($g_server->SelfServer->Cluster->Servers as $s) {
    $s_mbean_server = new MBeanServer($s->Name);

    $s_webapp = $s_mbean_server->lookup($webapp->mbean_name);

    echo "<tr class='toggle-sw_deploy_${webapp_id}'><td></td>";

    $name = $s->Name;
    if (! $name)
      $name = "default";
      
    printf("<td>%02d - %s</td>", $s->SelfServer->ClusterIndex, $name);

    echo "<td>";
    if ($s_webapp) {
      $s_repository = $s_webapp->getRepositoryMetaData();

      if ($s_repository["version"]) {
        $msg = $s_repository["version"];         
      }
      else if ($s_repository["date"]) {
        $msg = $s_repository["date"];
      }
      else {
        $msg = "not deployed";
      }

      if ($s_repository["root"] == $root) {
        print_ok($msg);
      }
      else {
        print_fail($msg);
      }
    }
    else {
      print_fail("--");
    }
    echo "</td>";

    echo "</tr>\n";
  }

  echo "</table>\n";
}

function display_deploy_form($mbean_server)
{
  global $is_secure;

  if ($is_secure) {
    $disabled = "";
  }
  else {
    $disabled = "disabled='true'";
    echo "<div class='warn'>Actions can only be performed over a secure connection (SSL)</div>";
  }

  echo "<div class='deploy-application'>";
  echo "<h3>Deploy new application</h3>";
  echo "<form enctype='multipart/form-data' method='POST'>";
  echo "<input type='hidden' name='action' value='deploy'>";

  echo "<h4>Application archive file</h4>";
  echo "<input type='file' name='application'>\n";

  echo "<h4>Name</h4>";
  echo "<input type='text' name='name' value='' class='required'>\n";

  echo "<h4>Version</h4>";
  echo "<input type='number' min='0' size='3' name='version-major' title='Major Version Number' value='0' class='required'>\n";
  echo "<input type='number' min='0' size='3' name='version-minor' title='Minor Version Number' value='0' class='required'>\n";
  echo "<input type='number' min='0' size='3' name='version-micro' title='Micro Version Number' value='0' class='required'>\n";
  echo "<input type='text' name='version-qualifier' title='Version Qualifier (free form)' value=''>\n";

  echo "<h4>Host</h4>";
  echo "<input class='host' type='radio' name='host' value='default' checked>";
  echo "Deploy to default host";
  echo "</input><br/>\n";
  echo "<span class='another-host'>\n";
  echo "<input type='radio' name='host' value=''>";
  echo "Deploy to another host: ";
  echo "<input type='text' name='host' value='' disabled>";
  echo "</input>\n";
  echo "</span>\n";

  echo "<h4>Stage</h4>";
  echo "<input class='stage' type='radio' name='stage' value='production' checked>";
  echo "Deploy to production";
  echo "</input><br/>\n";
  echo "<span class='another-stage'>\n";
  echo "<input type='radio' name='stage' value=''>";
  echo "Deploy to another stage: ";
  echo "<input type='text' name='stage' value='' disabled>";
  echo "</input>\n";
  echo "</span>\n";

  echo "<h4>Commit message</h4>";
  echo "<textarea name='commit-message'></textarea>\n";

  echo "<div style='text-align: right'>";
  echo "<input class='deploy' type='submit' name='submit' value='Deploy' $disabled>";
  echo "</div>";

  echo "</form>";
  echo "</div>";
}

function process_deploy_args()
{
  global $user;

  $commit = new Java("com.caucho.env.repository.CommitBuilder");

  $commit->type("webapp");

  $path = $_FILES['application']['tmp_name'];

  $stage = htmlspecialchars($_POST['stage']);

  if ($stage)
    $commit->stage($stage);
  else
    $commit->stage("production");

  $host = htmlspecialchars($_POST['host']);

  if (! $host)
    $host = "default";

  $name = htmlspecialchars($_POST['name']);

  if ($name == '/')
    $name = "/ROOT";

  if ($name[0] != '/')
    $name = '/' . $name;

  $commit->tagKey($host . $name);

  $major = $_POST['version-major'];
  $minor = $_POST['version-minor'];
  $micro = $_POST['version-micro'];
  $qualifier = $_POST['version-qualifier'];

  if ($major || $minor || $micro || $qualifier) {
    $commit->version(htmlspecialchars($major),
                     htmlspecialchars($minor),
                     htmlspecialchars($micro),
                     htmlspecialchars($qualifier));
  }

  if ($_POST['commit-message'])
    $commit->message($_POST['commit-message']);
  else
    $commit->message("updated via resin-admin web form");

  $commit->attribute("user", $user);

  return $commit;
}

function javascript_autocomplete()
{
  global $client;

  $tags = $client->queryTags("[^/]*/webapp/.*");

  $stages = array();
  $hosts = array();
  
  foreach ($tags as $tag) {
    $elements = explode("/", $tag->getTag());
    array_push($stages, "'{$elements[0]}'");
    array_push($hosts, "'{$elements[2]}'");
  }

  $stages = array_unique($stages);
  $hosts = array_unique($hosts);

  $stage_array = "[" . implode(",", $stages) . "]";
  $host_array = "[" . implode(",", $hosts) . "]";

  $javascript = <<<EOF
    var stages = ${stage_array};
    $("input:text.stage").autocomplete({ source: stages });
    var hosts = ${host_array};
    $("input:text.host").autocomplete({ source: hosts });
EOF;

  return $javascript;
}

function javascript_deploy_form()
{
  $javascript = javascript_autocomplete();

  $javascript .= <<<EOF
    var applicationNameInput = $(".deploy-application input[name=name]");
    var applicationFileInput = $(".deploy-application input:file[name='application']");

    applicationFileInput.change(function() {
      if (applicationNameInput.val() == "") {
        var filename = applicationFileInput.val();
        var match = /(.*\/)*(.*)\.war$/.exec(filename);

        if (match) {
          applicationNameInput.val(match[2]);
        }
      }
      
    });

    var hostRadio = $("input:radio[name=host]");
    var anotherHostRadio = $(".another-host input:radio");
    var anotherHostInput = $(".another-host input:text");

    hostRadio.change(function() {
      if (anotherHostRadio.attr("checked")) {
        $(".another-host").css("color", "black");
        anotherHostInput.attr('disabled', false);
      }
      else {
        $(".another-host").css("color", "#999");
        anotherHostInput.attr('disabled', true);
      }
    });

    var stageRadio = $("input:radio[name=stage]");
    var anotherStageRadio = $(".another-stage input:radio");
    var anotherStageInput = $(".another-stage input:text");

    stageRadio.change(function() {
      if (anotherStageRadio.attr("checked")) {
        $(".another-stage").css("color", "black");
        anotherStageInput.attr('disabled', false);
      }
      else {
        $(".another-stage").css("color", "#999");
        anotherStageInput.attr('disabled', true);
      }
    });
EOF;

  return $javascript;
}

$javascript = javascript_create_tab("webapp-tabs") .
              javascript_deploy_form();

display_footer($g_page, $javascript);
?>
