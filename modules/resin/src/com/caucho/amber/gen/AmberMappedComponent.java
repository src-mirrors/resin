/*
 * Copyright (c) 1998-2006 Caucho Technology -- all rights reserved
 *
 * This file is part of Resin(R) Open Source
 *
 * Each copy or derived work must preserve the copyright notice and this
 * notice unmodified.
 *
 * Resin Open Source is free software; you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation; either version 2 of the License, or
 * (at your option) any later version.
 *
 * Resin Open Source is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE, or any warranty
 * of NON-INFRINGEMENT.  See the GNU General Public License for more
 * details.
 *
 * You should have received a copy of the GNU General Public License
 * along with Resin Open Source; if not, write to the
 *
 *   Free Software Foundation, Inc.
 *   59 Temple Place, Suite 330
 *   Boston, MA 02111-1307  USA
 *
 * @author Scott Ferguson
 */

package com.caucho.amber.gen;

import com.caucho.amber.field.*;
import com.caucho.amber.table.Column;
import com.caucho.amber.table.Table;
import com.caucho.amber.type.EmbeddableType;
import com.caucho.amber.type.EntityType;
import com.caucho.amber.type.MappedSuperclassType;
import com.caucho.amber.type.RelatedType;
import com.caucho.amber.type.SubEntityType;
import com.caucho.amber.type.Type;
import com.caucho.bytecode.*;
import com.caucho.java.JavaWriter;
import com.caucho.java.gen.ClassComponent;
import com.caucho.loader.Environment;
import com.caucho.util.CharBuffer;
import com.caucho.util.L10N;
import com.caucho.vfs.PersistentDependency;

import javax.persistence.CascadeType;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashSet;

/**
 * Generates the Java code for the wrapped object.
 */
abstract public class AmberMappedComponent extends ClassComponent {
  private static final L10N L = new L10N(AmberMappedComponent.class);

  String _baseClassName;
  String _extClassName;

  RelatedType _relatedType;

  private ArrayList<PersistentDependency> _dependencies =
    new ArrayList<PersistentDependency>();

  public AmberMappedComponent()
  {
  }

  /**
   * Sets the bean info for the generator
   */
  void setRelatedType(RelatedType relatedType)
  {
    _relatedType = relatedType;

    _dependencies.addAll(relatedType.getDependencies());

    for (int i = 0; i < _dependencies.size(); i++)
      Environment.addDependency(_dependencies.get(i));
  }

  /**
   * Sets the base class name
   */
  public void setBaseClassName(String baseClassName)
  {
    _baseClassName = baseClassName;
  }

  /**
   * Gets the base class name
   */
  public String getBaseClassName()
  {
    return _baseClassName;
  }

  /**
   * Sets the ext class name
   */
  public void setExtClassName(String extClassName)
  {
    _extClassName = extClassName;
  }

  /**
   * Sets the ext class name
   */
  public String getClassName()
  {
    return _extClassName;
  }

  /**
   * Get bean class name.
   */
  public String getBeanClassName()
  {
    // return _relatedType.getBeanClass().getName();
    return _baseClassName;
  }

  /**
   * Returns the dependencies.
   */
  public ArrayList<PersistentDependency> getDependencies()
  {
    return _dependencies;
  }

  /**
   * Generates the class header for the generated code.
   */
  void generateHeader(JavaWriter out,
                      boolean isEntityParent)
    throws IOException
  {
    out.println("/*");
    out.println(" * Generated by Resin Amber");
    out.println(" * " + com.caucho.Version.VERSION);
    out.println(" */");
    out.print("private static final java.util.logging.Logger __caucho_log = ");
    out.println("java.util.logging.Logger.getLogger(\"" + getBeanClassName() + "\");");

    // jpa/0ge3 if (! isEntityParent) {
    if (_relatedType.getParentType() == null) {
      out.println();
      out.println("protected transient com.caucho.amber.type.EntityType __caucho_home;");
      out.println("public transient com.caucho.amber.entity.EntityItem __caucho_cacheItem;");
      out.println("protected transient com.caucho.amber.manager.AmberConnection __caucho_session;");
      out.println("protected transient com.caucho.amber.entity.EntityState __caucho_state = com.caucho.amber.entity.EntityState.TRANSIENT;");

      // XXX: needs to generate load masks for groups in the subclasses,
      // but the group numbering should not always start at zero.

      int loadCount = _relatedType.getLoadGroupIndex();
      for (int i = 0; i <= loadCount / 64; i++) {
        out.println("protected transient long __caucho_loadMask_" + i + ";");
      }

      int dirtyCount = _relatedType.getDirtyIndex();

      for (int i = 0; i <= dirtyCount / 64; i++) {
        out.println("protected transient long __caucho_dirtyMask_" + i + ";");
        out.println("protected transient long __caucho_updateMask_" + i + ";");
      }

      out.println("protected transient boolean __caucho_inc_version;");
    }
  }

  /**
   * Generates the init generated code.
   */
  void generateInit(JavaWriter out,
                    boolean isEntityParent)
    throws IOException
  {
    if (isEntityParent)
      return;

    // XXX: needs to handle this with subclasses
    // but there is an issue in the enhancer fixup
    // removing the "super." call.
    /*
      out.println();
      out.println("public void __caucho_postConstructor()");
      out.println("{");
      out.pushDepth();

      ArrayList<AmberField> fields = _relatedType.getFields();

      for (int i = 0; i < fields.size(); i++) {
        AmberField field = fields.get(i);

        if (field instanceof AbstractField) {
          AbstractField f = (AbstractField) field;
          f.generatePostConstructor(out);
        }
      }

      out.popDepth();
      out.println("}");
    */

    String className = getClassName();
    int p = className.lastIndexOf('.');
    if (p > 0)
      className = className.substring(p + 1);

    ArrayList<AmberField> fields = _relatedType.getFields();

    for (JMethod ctor : _relatedType.getBeanClass().getConstructors()) {
      out.println();
      // XXX: s/b actual access type?
      out.print("public ");

      out.print(className);
      out.print("(");

      JClass []args = ctor.getParameterTypes();
      for (int i = 0; i < args.length; i++) {
        if (i != 0)
          out.print(", ");

        out.print(args[i].getPrintName());
        out.print(" a" + i);
      }
      out.println(")");
      out.println("{");
      out.pushDepth();

      out.print("super(");
      for (int i = 0; i < args.length; i++) {
        if (i != 0)
          out.print(", ");

        out.print("a" + i);
      }
      out.println(");");

      // jpa/0l14
      out.println("__caucho_state = com.caucho.amber.entity.EntityState.TRANSIENT;");

      // jpa/0gh2: compound pk and constructor with arguments.
      if (_relatedType.getId() instanceof CompositeId) {
        out.println("try {");
        out.println("  __caucho_setPrimaryKey(__caucho_getPrimaryKey());");
        out.println("} catch (Exception e) {");
        out.println("  __caucho_log.fine(\"amber unable to set primary key within argument constructor \" + this.getClass().getName() + \" - PK: unknown\");");
        out.println("}");
      }

      for (AmberField field : fields) {
        field.generatePostConstructor(out);
      }

      out.popDepth();
      out.println("}");
    }

    Id id = _relatedType.getId();

    if (id == null) {
      if (_relatedType instanceof EntityType)
        throw new IllegalStateException(L.l("`{0}' is missing a key.",
                                            _relatedType.getName()));
    } // ejb/0623 as a negative test.
    else if (id instanceof CompositeId) {
      // jpa/0u21
      out.println();
      out.println("private " + id.getForeignTypeName() + " __caucho_compound_key = new " + id.getForeignTypeName() + "();");
    }

    boolean isAbstract = (_relatedType.getBeanClass().isAbstract()
                          && _relatedType.getPersistenceUnit().isJPA());

    out.println();
    out.println("public void __caucho_setPrimaryKey(Object key)");
    out.println("{");
    out.pushDepth();

    if (id != null && ! isAbstract)
      id.generateSet(out, id.generateCastFromObject("key"));

    out.popDepth();
    out.println("}");

    out.println();
    out.println("public Object __caucho_getPrimaryKey()");
    out.println("{");
    out.pushDepth();

    out.println("try {");
    out.pushDepth();

    out.print("return ");

    if (id == null || isAbstract)
      out.print("null");
    else
      out.print(id.toObject(id.generateGetProperty("super")));

    out.println(";");

    out.popDepth();
    out.println("} catch (Exception e) {");
    out.println("  throw new com.caucho.amber.AmberRuntimeException(e);");
    out.println("}");

    out.popDepth();
    out.println("}");

    /*
      println();
      println("public com.caucho.amber.entity.EntityItem __caucho_getCacheItem()");
      println("{");
      pushDepth();

      println("return __caucho_cacheItem;");

      popDepth();
      println("}");

      println();
      println("public void __caucho_setCacheItem(com.caucho.amber.entity.EntityItem item)");
      println("{");
      pushDepth();

      println("__caucho_cacheItem = item;");

      popDepth();
      println("}");
    */

    out.println();
    out.println("public void __caucho_setConnection(com.caucho.amber.manager.AmberConnection aConn)");
    out.println("{");
    out.pushDepth();

    out.println("__caucho_session = aConn;");

    out.popDepth();
    out.println("}");

    out.println();
    out.println("public com.caucho.amber.manager.AmberConnection __caucho_getConnection()");
    out.println("{");
    out.pushDepth();

    out.println("return __caucho_session;");

    out.popDepth();
    out.println("}");

    generateExpire(out);
  }

  /**
   * Generates the expire code.
   */
  void generateExpire(JavaWriter out)
    throws IOException
  {
    out.println();
    out.println("public void __caucho_expire()");
    out.println("{");
    out.pushDepth();

    out.println("if (__caucho_log.isLoggable(java.util.logging.Level.FINE)) {");
    out.pushDepth();

    out.println("try {");
    out.println("  __caucho_log.fine(\"amber expire \" + this.getClass().getName() + \" - PK: \" + __caucho_getPrimaryKey());");
    out.println("} catch (Exception e) {");
    out.println("  __caucho_log.fine(\"amber expire \" + this.getClass().getName() + \" - PK: unknown\");");
    out.println("}");

    out.popDepth();
    out.println("}");
    out.println();

    int loadCount = _relatedType.getLoadGroupIndex();
    for (int i = 0; i <= loadCount / 64; i++) {
      out.println("__caucho_loadMask_" + i + " = 0L;");
    }

    _relatedType.generateExpire(out);

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates checks for entity-relationship consistency.
   */
  void generateDumpRelationships(JavaWriter out)
    throws IOException
  {
    out.println();
    out.println("public void __caucho_dumpRelationships()");
    out.println("{");
    out.pushDepth();

    out.println("if (! __caucho_log.isLoggable(java.util.logging.Level.FINEST))");
    out.println("  return;");
    out.println();

    out.println("if (__caucho_session == null)");
    out.println("  return;");
    out.println();

    out.println("com.caucho.amber.manager.AmberPersistenceUnit unit = __caucho_session.getPersistenceUnit();");
    out.println();

    out.println("com.caucho.amber.entity.Entity thisRef;");

    for (int i = 0; i <= _relatedType.getLoadGroupIndex(); i++) {
      _relatedType.generateDumpRelationships(out, i);
    }

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the isDirty code.
   */
  void generateIsDirty(JavaWriter out)
    throws IOException
  {
    out.println();
    out.println("public boolean __caucho_isDirty()");
    out.println("{");
    out.pushDepth();

    int dirtyCount = _relatedType.getDirtyIndex();

    for (int i = 0; i <= dirtyCount / 64; i++) {
      out.println("if (__caucho_dirtyMask_" + i + " != 0L)");
      out.println("  return true;");
      out.println();
    }

    out.println("return false;");

    out.popDepth();
    out.println("}");
  }


  /**
   * Generates the match code.
   */
  void generateMatch(JavaWriter out)
    throws IOException
  {
    out.println();
    out.println("public boolean __caucho_match(String className, Object key)");
    out.println("{");
    out.pushDepth();

    /*
      out.println("if (! (" + getBeanClassName() + ".class.isAssignableFrom(cl)))");
      out.println("  return false;");
    */
    out.println("if (! (\"" + getBeanClassName() + "\".equals(className)))");
    out.println("  return false;");
    out.println("else {");
    out.pushDepth();

    Id id = _relatedType.getId();

    // jpa/0gg0
    if (id == null || _relatedType.getBeanClass().isAbstract()) {
      // jpa/0ge6: MappedSuperclass

      out.println("return true;");
      out.popDepth();
      out.println("}");
      out.popDepth();
      out.println("}");

      return;
    }

    out.println("try {");
    out.pushDepth();

    id.generateMatch(out, id.generateCastFromObject("key"));

    out.popDepth();
    out.println("} catch (ClassCastException e) {");
    out.println("  throw new IllegalArgumentException(\"Primary key type is incorrect: '\"+key.getClass().getName()+\"'\");");
    out.println("}");

    out.popDepth();
    out.println("}");

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the prologue.
   */
  void generatePrologue(JavaWriter out, HashSet<Object> completedSet)
    throws IOException
  {
    if (_relatedType.getColumns() != null) {
      for (Column column : _relatedType.getColumns())
        column.generatePrologue(out);
    }

    Id id = _relatedType.getId();

    boolean isAbstractParent = _relatedType.getParentType() == null
      || _relatedType.getParentType().getBeanClass().isAbstract();

    // jpa/0m02
    if (id != null && isAbstractParent)
      id.generatePrologue(out, completedSet);

    ArrayList<AmberField> fields = _relatedType.getFields();

    for (int i = 0; i < fields.size(); i++) {
      AmberField prop = fields.get(i);

      prop.generatePrologue(out, completedSet);
    }
  }

  /**
   * Generates the __caucho_getCacheEntity()
   */
  void generateGetCacheEntity(JavaWriter out)
    throws IOException
  {
    out.println();
    out.println("public com.caucho.amber.entity.Entity __caucho_getCacheEntity()");
    out.println("{");
    out.pushDepth();

    out.println("if (__caucho_cacheItem == null)");
    out.println("  return null;");

    out.println();
    out.println("return __caucho_cacheItem.getEntity();");

    out.popDepth();
    out.println("}");

    out.println();
    out.println("public com.caucho.amber.entity.EntityItem __caucho_getCacheItem()");
    out.println("{");
    out.pushDepth();

    out.println("return __caucho_cacheItem;");

    out.popDepth();
    out.println("}");

    out.println();
    out.println("public void __caucho_setCacheItem(com.caucho.amber.entity.EntityItem cacheItem)");
    out.println("{");
    out.pushDepth();

    out.println("__caucho_cacheItem = cacheItem;");

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the entity type
   */
  void generateGetEntityType(JavaWriter out)
    throws IOException
  {
    out.println();
    out.println("public com.caucho.amber.type.EntityType __caucho_getEntityType()");
    out.println("{");
    out.pushDepth();

    out.println("return __caucho_home;");

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the get entity state
   */
  void generateGetEntityState(JavaWriter out)
    throws IOException
  {
    out.println();
    out.println("public com.caucho.amber.entity.EntityState __caucho_getEntityState()");
    out.println("{");
    out.pushDepth();

    out.println("return __caucho_state;");

    out.popDepth();
    out.println("}");

    out.println();
    out.println("public void __caucho_setEntityState(com.caucho.amber.entity.EntityState state)");
    out.println("{");
    out.pushDepth();

    out.println("__caucho_state = state;");

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the fields.
   */
  void generateFields(JavaWriter out)
    throws IOException
  {
    ArrayList<AmberField> fields = _relatedType.getFields();

    for (int i = 0; i < fields.size(); i++) {
      AmberField prop = fields.get(i);

      prop.generateSuperGetter(out);
      prop.generateGetProperty(out);

      prop.generateSuperSetter(out);
      prop.generateSetProperty(out);
    }
  }

  /**
   * Generates the stub methods (needed for EJB)
   */
  void generateMethods(JavaWriter out)
    throws IOException
  {
    for (StubMethod method : _relatedType.getMethods()) {
      method.generate(out);
    }
  }

  /**
   * Generates the load
   */
  void generateLoad(JavaWriter out,
                    boolean isEntityParent)
    throws IOException
  {
    // commented out: jpa/0l03
    // if (_relatedType.getParentType() != null)
    //   return;

    if (! isEntityParent) {
      out.println();
      out.println("public boolean __caucho_makePersistent(com.caucho.amber.manager.AmberConnection aConn, com.caucho.amber.type.EntityType home)");
      out.println("  throws java.sql.SQLException");
      out.println("{");
      out.pushDepth();

      out.println("__caucho_session = aConn;");
      out.println("if (home != null)");
      out.println("  __caucho_home = home;");

      // XXX: makePersistent is called in contexts other than the P_NON_TRANSACTIONAL one, so this setting is inappropriate
      // out.println("__caucho_state = com.caucho.amber.entity.EntityState.P_NON_TRANSACTIONAL;");

      int loadCount = _relatedType.getLoadGroupIndex();
      for (int i = 0; i <= loadCount / 64; i++) {
        out.println("__caucho_loadMask_" + i + " = 0L;");
      }

      int dirtyCount = _relatedType.getDirtyIndex();
      for (int i = 0; i <= dirtyCount / 64; i++) {
        out.println("__caucho_dirtyMask_" + i + " = 0L;");
        out.println("__caucho_updateMask_" + i + " = 0L;");
      }

      out.println();
      out.println("return true;");

      out.popDepth();
      out.println("}");
    }

    int index = _relatedType.getLoadGroupIndex();

    boolean hasLoad = (_relatedType.getFields().size() > 0);

    if (! isEntityParent) {
      index = 0;
      hasLoad = hasLoad || (_relatedType.getId() != null);
    }

    // jpa/0l20
    if (true || hasLoad || ! isEntityParent) {
      out.println();
      out.println("public void __caucho_retrieve_eager(com.caucho.amber.manager.AmberConnection aConn)");
      out.println("{");

      generateRetrieveEager(out, _relatedType);

      out.println("}");
      out.println();
      out.println("public void __caucho_retrieve_self(com.caucho.amber.manager.AmberConnection aConn)");
      out.println("{");
      out.pushDepth();

      generateRetrieveSelf(out, _relatedType);

      out.popDepth();
      out.println("}");
    }
  }

  private void generateRetrieveEager(JavaWriter out, RelatedType relatedType)
    throws IOException
  {
    if (relatedType == null)
      return;

    int index = relatedType.getLoadGroupIndex();

    boolean hasLoad = (relatedType.getFields().size() > 0);

    if (relatedType.getParentType() == null) {
      index = 0;
      hasLoad = true;
    }

    generateRetrieveEager(out, relatedType.getParentType());

    if (hasLoad)
      out.println("__caucho_load_" + index + "(aConn);");
  }

  private void generateRetrieveSelf(JavaWriter out, RelatedType relatedType)
    throws IOException
  {
    if (relatedType == null)
      return;

    int index = relatedType.getLoadGroupIndex();

    boolean hasLoad = (relatedType.getFields().size() > 0);

    if (relatedType.getParentType() != null) {
      generateRetrieveSelf(out, relatedType.getParentType());
    }
    else {
      index = 0;
      hasLoad = true;
    }

    if (hasLoad) {
      int group = index / 64;
      long mask = (1L << (index % 64));
      
      out.println("if ((__caucho_loadMask_" + group + " & " + mask + "L) == 0)");
      
      out.println("  __caucho_load_select_" + index + "(aConn);");
    }
  }

  /**
   * Generates the detach
   */
  void generateDetach(JavaWriter out,
                      boolean isEntityParent)
    throws IOException
  {
    if (isEntityParent)
      return;

    out.println();
    out.println("public void __caucho_detach()");
    out.println("{");
    out.pushDepth();

    out.println("if (__caucho_log.isLoggable(java.util.logging.Level.FINE))");
    out.println("  __caucho_log.fine(\"amber detach \" + this.getClass().getName() + \" - PK: \" + __caucho_getPrimaryKey());");
    out.println();

    // jpa/0l14
    if (_relatedType instanceof EntityType) {
      // jpa/0o05
      out.println("__caucho_dumpRelationships();");
    }

    out.println();
    out.println("__caucho_session = null;");

    // jpa/0x00
    // out.println("__caucho_home = null;");

    out.println("__caucho_state = com.caucho.amber.entity.EntityState.TRANSIENT;");

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the load group.
   */
  void generateLoadGroup(JavaWriter out, int groupIndex)
    throws IOException
  {
    if (_relatedType.hasLoadGroup(groupIndex)) {
      new LoadGroupGenerator(_extClassName,
                             _relatedType,
                             groupIndex).generate(out);
    }
  }

  /**
   * Generates the load
   */
  void generateResultSetLoad(JavaWriter out,
                             boolean isEntityParent)
    throws IOException
  {
    if (isEntityParent)
      return;

    out.println();
    out.println("public int __caucho_load(com.caucho.amber.manager.AmberConnection aConn, java.sql.ResultSet rs, int index)");
    out.println("  throws java.sql.SQLException");
    out.println("{");
    out.pushDepth();

    int index = _relatedType.generateLoad(out, "rs", "index", 0, 0, null);

    out.println("__caucho_loadMask_0 |= 1L;");

    int dirtyCount = _relatedType.getDirtyIndex();

    for (int i = 0; i <= dirtyCount / 64; i++) {
      out.println("__caucho_dirtyMask_" + i + " = 0;");

      // ejb/0645
      // out.println("__caucho_updateMask_" + i + " = 0;");
    }

    out.println();
    out.println("if (__caucho_cacheItem == null) {");
    // the cache item does not have its state changed
    out.println("}");
    out.println("else if (__caucho_state.isTransactional()) {");
    out.println("}");
    out.println("else if (__caucho_session == null ||");
    out.println("         ! __caucho_session.isActiveTransaction()) {");
    out.println("  __caucho_state = com.caucho.amber.entity.EntityState.P_NON_TRANSACTIONAL;");
    out.println("  if (__caucho_cacheItem != null)");
    out.println("    __caucho_cacheItem.save((com.caucho.amber.entity.Entity) this);");
    out.println("}");
    out.println("else {");
    out.println("  __caucho_state = com.caucho.amber.entity.EntityState.P_TRANSACTIONAL;");
    out.println("  aConn.makeTransactional((com.caucho.amber.entity.Entity) this);");
    out.println("}");

    if (_relatedType.getHasLoadCallback()) {
      out.println();
      out.println("__caucho_load_callback();");
    }

    out.println("return " + index + ";");
    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the load
   */
  void generateSetQuery(JavaWriter out,
                        boolean isEntityParent)
    throws IOException
  {
    if (isEntityParent)
      return;

    out.println();
    out.println("public void __caucho_setKey(java.sql.PreparedStatement pstmt, int index)");
    out.println("  throws java.sql.SQLException");
    out.println("{");
    out.pushDepth();

    // jpa/0gg0 vs jpa/06c5
    if (! _relatedType.isAbstractClass())
      _relatedType.generateSet(out, "pstmt", "index", "super");

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the increment version
   */
  void generateIncrementVersion(JavaWriter out)
    throws IOException
  {
    out.println();
    out.println("public void __caucho_increment_version()");
    out.println("{");
    out.pushDepth();

    if (_relatedType instanceof EntityType) {
      out.println("if (__caucho_inc_version)");
      out.println("  return;");
      out.println();
      out.println("__caucho_inc_version = true;");

      VersionField version = _relatedType.getVersionField();

      if (version != null)
        version.generateIncrementVersion(out);
    }

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the flush
   */
  void generateFlush(JavaWriter out)
    throws IOException
  {
    out.println();
    out.println("protected void __caucho_flush_callback()");
    out.println("  throws java.sql.SQLException");
    out.println("{");
    out.println("}");

    out.println();
    out.println("public boolean __caucho_flush()");
    out.println("  throws java.sql.SQLException");
    out.println("{");
    out.pushDepth();

    boolean isAbstract = (_relatedType.getBeanClass().isAbstract()
                          && _relatedType.getPersistenceUnit().isJPA());

    if (_relatedType.getId() == null || isAbstract) {
      // jpa/0ge6: MappedSuperclass

      out.println("return false;");
      out.popDepth();
      out.println("}");

      return;
    }

    out.println("if (__caucho_session == null)");
    out.println("  return false;");
    out.println();

    ArrayList<AmberField> fields = _relatedType.getFields();

    for (int i = 0; i < fields.size(); i++) {
      AmberField field = fields.get(i);

      if (field.isCascadable()) {
        CascadableField cascadable = (CascadableField) field;

        cascadable.generateFlushCheck(out);

        out.println();
      }
    }

    out.println();
    out.println("if (__caucho_state == com.caucho.amber.entity.EntityState.P_DELETED) {");
    out.println("  __caucho_delete_int();");
    out.println("  return true;");
    out.println("}");
    out.println("else if (__caucho_state == com.caucho.amber.entity.EntityState.P_PERSISTING) {");
    // jpa/0ga2
    out.println("  __caucho_create(__caucho_session, __caucho_home);");
    out.println("}");
    out.println("else if (__caucho_state == com.caucho.amber.entity.EntityState.P_PERSISTED) {");
    out.println("  __caucho_cascadePrePersist(__caucho_session);");
    out.println("}");
    out.println();

    out.println("boolean isDirty = false;");

    int dirtyCount = _relatedType.getDirtyIndex();

    for (int i = 0; i <= dirtyCount / 64; i++) {
      out.println("long mask_" + i + " = __caucho_dirtyMask_" + i + ";");
      out.println("__caucho_dirtyMask_" + i + " = 0L;");
      out.println("__caucho_updateMask_" + i + " |= mask_" + i + ";");

      out.println();
      out.println("if (mask_" + i + " != 0L)");
      out.println("  isDirty = true;");
    }

    out.println();

    // if (version == null)
    out.println("if (isDirty) {");
    out.pushDepth();

    // ejb/0605
    out.println();
    out.println("__caucho_flush_callback();");

    // else {
    // jpa/0x02
    //  out.println("if (! (isDirty || " + version.generateIsNull() + "))");
    // }
    // out.println("  return true;");

    // jpa/0r10
    out.println("__caucho_home.preUpdate(this);");

    // jpa/0r10
    generateCallbacks(out, "this", _relatedType.getPreUpdateCallbacks());

    out.println("com.caucho.util.CharBuffer cb = new com.caucho.util.CharBuffer();");

    out.println("__caucho_home.generateUpdateSQLPrefix(cb);");

    out.println("boolean isFirst = true;");

    VersionField version = _relatedType.getVersionField();

    for (int i = 0; i <= dirtyCount / 64; i++) {
      // jpa/0x02 is a negative test.
      if (i != 0 || version == null) {
        out.println("if (mask_" + i + " != 0L)");
        out.print("  ");
      }

      out.println("isFirst = __caucho_home.generateUpdateSQLComponent(cb, " + i + ", mask_" + i + ", isFirst);");
    }
    out.println("__caucho_home.generateUpdateSQLSuffix(cb);");

    out.println();
    out.println("java.sql.PreparedStatement pstmt = null;");
    out.println("String sql = cb.toString();");
    out.println();
    out.println("try {");
    out.pushDepth();

    out.println("pstmt = __caucho_session.prepareStatement(sql);");

    out.println("int index = 1;");

    for (int i = 0; i < fields.size(); i++) {
      AmberField field = fields.get(i);

      field.generateUpdate(out, "mask", "pstmt", "index");
    }

    out.println();
    _relatedType.getId().generateSet(out, "pstmt", "index");

    if (version != null) {
      out.println();
      version.generateSet(out, "pstmt", "index");
    }

    out.println();
    out.println("int updateCount = pstmt.executeUpdate();");
    out.println();

    if (version != null) {
      out.println("if (updateCount == 0) {");
      out.println("  throw new javax.persistence.OptimisticLockException((com.caucho.amber.entity.Entity) this);");
      out.println("} else {");
      out.pushDepth();
      String value = version.generateGet("super");
      Type type = version.getColumn().getType();
      out.println(version.generateSuperSetter(type.generateIncrementVersion(value)) + ";");
      out.popDepth();
      out.println("}");
      out.println();
    }

    out.println("__caucho_home.postUpdate(this);");

    generateCallbacks(out, "this", _relatedType.getPostUpdateCallbacks());

    out.println();
    out.println("if (__caucho_log.isLoggable(java.util.logging.Level.FINE))");
    out.println("  __caucho_log.fine(\"amber update \" + this.getClass().getName() + \" - PK: \" + __caucho_getPrimaryKey());");

    out.println();
    out.println("__caucho_inc_version = false;");
    out.println();

    out.popDepth();
    out.println("} catch (Exception e) {");
    out.println("  if (pstmt != null)");
    out.println("    __caucho_session.closeStatement(sql);");
    out.println();
    out.println("  if (e instanceof java.sql.SQLException)");
    out.println("    throw (java.sql.SQLException) e;");
    out.println();
    out.println("  if (e instanceof RuntimeException)");
    out.println("    throw (RuntimeException) e;");
    out.println();
    out.println("  throw new com.caucho.amber.AmberRuntimeException(e);");
    out.println("}");

    out.popDepth();
    out.println("}");

    out.println("if (__caucho_state == com.caucho.amber.entity.EntityState.P_PERSISTED) {");
    out.println("  __caucho_cascadePostPersist(__caucho_session);");
    out.println("}");

    out.println();
    out.println("return false;");

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the update
   */
  void generateFlushUpdate(JavaWriter out,
                           boolean isEntityParent)
    throws IOException
  {
    out.println();
    out.println("protected void __caucho_flushUpdate(long mask, com.caucho.amber.type.EntityType home)");
    out.println("  throws java.sql.SQLException");
    out.println("{");
    out.pushDepth();

    if (isEntityParent) {
      out.println("super.__caucho_flushUpdate(mask, home.getParentType());");
    }

    out.println("String sql = home.generateUpdateSQL(mask);");

    out.println("if (sql != null) {");
    out.pushDepth();

    out.println("java.sql.PreparedStatement pstmt = __caucho_session.prepareStatement(sql);");

    out.println("int index = 1;");

    ArrayList<AmberField> fields = _relatedType.getFields();
    for (int i = 0; i < fields.size(); i++) {
      AmberField field = fields.get(i);

      field.generateUpdate(out, "mask", "pstmt", "index");
    }

    out.println();
    _relatedType.getId().generateSet(out, "pstmt", "index");

    out.println();
    out.println("pstmt.executeUpdate();");

    out.println();
    out.println("if (__caucho_log.isLoggable(java.util.logging.Level.FINE))");
    out.println("  __caucho_log.fine(\"amber update \" + this.getClass().getName() + \" - PK: \" + __caucho_getPrimaryKey());");

    // println();
    // println("pstmt.close();");

    out.popDepth();
    out.println("}");

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the after-commit
   */
  void generateAfterCommit(JavaWriter out,
                           boolean isEntityParent)
    throws IOException
  {
    // XXX: needs to handle this with subclasses
    // but there is an issue in the enhancer fixup
    // removing the "super." call.
    // if (_relatedType.getParentType() != null) {
    //   out.println();
    //   out.println("public void __caucho_super_afterCommit()");
    //   out.println("{");
    //   out.println("  super.__caucho_afterCommit();");
    //   out.println("}");
    // }

    out.println();
    out.println("public void __caucho_afterCommit()");
    out.println("{");
    out.pushDepth();

    // ejb/06c9
    out.println("com.caucho.amber.entity.EntityState state = __caucho_state;");
    out.println();

    out.println("__caucho_state = com.caucho.amber.entity.EntityState.P_NON_TRANSACTIONAL;");

    out.println();
    out.println("if (__caucho_session == null) {");

    int dirtyCount = _relatedType.getDirtyIndex();
    for (int i = 0; i <= dirtyCount / 64; i++) {
      out.println("  __caucho_updateMask_" + i + " = 0L;");
    }

    out.println("  return;");
    out.println("}");
    out.println();

    // jpa/0h20, jpa/0l20, jpa/0l43
    out.println("if (__caucho_cacheItem == null)");
    out.println("  return;");
    out.println();

    // ejb/06c9
    out.println("if (com.caucho.amber.entity.EntityState.P_DELETING.ordinal() <= state.ordinal())");
    out.println("  return;");
    out.println();

    out.println("Object pk = __caucho_getPrimaryKey();");
    out.println("__caucho_session.getPersistenceUnit().updateCacheItem((com.caucho.amber.type.EntityType) __caucho_home.getRootType(), pk, this, __caucho_cacheItem);");

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the update cache item.
   */
  void generateUpdateCacheItem(JavaWriter out,
                               boolean isEntityParent)
    throws IOException
  {
    out.println();
    out.println("public void __caucho_updateCacheItem(com.caucho.amber.entity.Entity cacheEntity)");
    out.println("{");
    out.pushDepth();

    out.println("com.caucho.amber.manager.AmberConnection aConn = __caucho_session;");

    out.println("com.caucho.amber.entity.EntityState state = __caucho_state;");
    int dirtyCount = _relatedType.getDirtyIndex();
    for (int i = 0; i <= dirtyCount / 64; i++) {
      out.println("long updateMask_" + i + " = __caucho_updateMask_" + i + ";");
    }

    for (int i = 0; i <= dirtyCount / 64; i++) {
      out.println("__caucho_updateMask_" + i + " = 0L;");
    }

    out.println();
    out.println(_extClassName + " item = (" + _extClassName + ") cacheEntity;");

    out.println("try {");
    out.pushDepth();

    // jpa/0o01
    out.println("Object child;");

    if (! isEntityParent) {
      // if loaded in transaction, then copy results
      // ejb/0600, ejb/0a06, ejb/0893
      out.println("if ((__caucho_loadMask_0 & 1L) != 0) {");
      out.pushDepth();
      out.println("item.__caucho_loadMask_0 = 1L;");

      _relatedType.generateCopyLoadObject(out, "item", "super", 0);
    }

    for (int i = 1; i <= _relatedType.getLoadGroupIndex(); i++) {
      String loadVar = "__caucho_loadMask_" + (i / 64);
      long mask = (1L << (i % 64));

      // jpa/0l02: if (_relatedType.isLoadGroupOwnedByType(i)) {
      out.println("if ((" + loadVar + " & " + mask + "L) != 0) {");
      out.pushDepth();

      _relatedType.generateCopyLoadObject(out, "item", "super", i);

      out.println("item." + loadVar + " |= " + mask + "L;");

      out.popDepth();
      out.println("}");
      //}
    }

    if (! isEntityParent) {
      out.popDepth();
      out.println("}");
    }

    for (int i = 0; i < _relatedType.getDirtyIndex(); i++) {
      int group = i / 64;
      long mask = (1L << (i % 64));

      if (_relatedType.isDirtyIndexOwnedByType(i)) {
        out.println("if ((updateMask_" + group + " & " + mask + "L) != 0) {");
        out.pushDepth();

        _relatedType.generateCopyUpdateObject(out, "item", "super", i);

        out.popDepth();
        out.println("}");
      }
    }

    out.popDepth();
    out.println("} catch (RuntimeException e) {");
    out.println("  throw e;");
    out.println("} catch (Exception e) {");
    out.println("  throw new com.caucho.amber.AmberRuntimeException(e);");
    out.println("}");

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the after-rollback
   */
  void generateAfterRollback(JavaWriter out)
    throws IOException
  {
    out.println();
    out.println("public void __caucho_afterRollback()");
    out.println("{");
    out.pushDepth();

    out.println("__caucho_state = com.caucho.amber.entity.EntityState.P_NON_TRANSACTIONAL;");

    int loadCount = _relatedType.getLoadGroupIndex();
    for (int i = 0; i <= loadCount / 64; i++) {
      out.println("__caucho_loadMask_" + i + " = 0L;");
    }

    int dirtyCount = _relatedType.getDirtyIndex();
    for (int i = 0; i <= dirtyCount / 64; i++) {
      out.println("__caucho_dirtyMask_" + i + " = 0L;");
    }

    out.popDepth();
    out.println("}");
  }

  String getDebug()
  {
    return "this";
  }

  /**
   * Generates the update
   */
  void generateCreate(JavaWriter out)
    throws IOException
  {
    boolean isAbstract = (_relatedType.getBeanClass().isAbstract()
                          && _relatedType.getPersistenceUnit().isJPA());

    boolean isGeneratedValue = false;

    // jpa/0gg0
    if (_relatedType.getId() != null && ! isAbstract) {
      ArrayList<IdField> fields = _relatedType.getId().getKeys();
      IdField idField = fields.size() > 0 ? fields.get(0) : null;

      boolean hasReturnGeneratedKeys = false;

      try {
        hasReturnGeneratedKeys = _relatedType.getPersistenceUnit().hasReturnGeneratedKeys();
      } catch (Exception e) {
        // Meta-data exception which is acceptable or
        // no data-source configured. The latter will
        // be thrown on web.xml validation. (ejb/06m0)
      }

      if (idField != null && idField.isAutoGenerate())
        isGeneratedValue = true;

      if (! hasReturnGeneratedKeys &&
          idField != null && idField.getType().isAutoIncrement()) {
        out.println();
        out.println("private static com.caucho.amber.field.Generator __caucho_id_gen;");
        out.println("static {");
        out.pushDepth();
        out.println("com.caucho.amber.field.MaxGenerator gen = new com.caucho.amber.field.MaxGenerator();");
        out.print("gen.setColumn(\"");
        out.printJavaString(idField.getColumns().get(0).generateInsertName());
        out.println("\");");
        out.print("gen.setTable(\"");
        out.printJavaString(_relatedType.getName());
        out.println("\");");
        out.println("gen.init();");
        out.popDepth();
        out.println("}");
      }
    }

    // jpa/0ga2
    out.println();
    out.println("public boolean __caucho_lazy_create(com.caucho.amber.manager.AmberConnection aConn, com.caucho.amber.type.EntityType home)");
    out.println("  throws java.sql.SQLException");
    out.println("{");
    out.pushDepth();

    int loadCount = 0;

    // jpa/0ge2: MappedSuperclassType
    if ((_relatedType.getTable() == null) || (_relatedType.getId() == null)) {
      out.println("return false;");

      out.popDepth();
      out.println("}");
    }
    else {
      out.println("if (__caucho_session != null)");
      out.println("  return true;");
      out.println();

      // commented out: jpa/0h25
      // out.println("  throw new com.caucho.amber.AmberException(\"object \" + " + getDebug() + " + \" is already persistent.\");");

      out.println("__caucho_state = com.caucho.amber.entity.EntityState.P_PERSISTING;");

      loadCount = _relatedType.getLoadGroupIndex();
      for (int i = 0; i <= loadCount / 64; i++) {
        out.println("__caucho_loadMask_" + i + " = 0L;");

        // XXX: jpa/0l21

        RelatedType parentType = _relatedType;

        do {
          out.println("__caucho_loadMask_" + i + " |= " + parentType.getCreateLoadMask(i) + ";");
        } while ((parentType = parentType.getParentType()) != null);
      }

      out.println();
      out.println("__caucho_session = aConn;");
      out.println("__caucho_home = home;");

      out.println("__caucho_home.prePersist(this);");

      // jpa/0r20
      for (JMethod method : _relatedType.getPrePersistCallbacks()) {
        out.println(method.getName() + "();");
      }

      if (isGeneratedValue) {
        // jpa/0g50: generated id needs to flush the insert statement at persist() time.
        out.println("__caucho_create(aConn, home);");
      }
      else {
        // jpa/0j5e: persist() is lazy but should cascade to add entities to the context.
        out.println();
        out.println("__caucho_cascadePrePersist(aConn);");

        out.println("__caucho_cascadePostPersist(aConn);");
      }

      out.println("__caucho_home.postPersist(this);");

      for (JMethod method : _relatedType.getPostPersistCallbacks()) {
        out.println(method.getName() + "();");
      }

      out.println();
      out.println("return true;");

      out.popDepth();
      out.println("}");
    }

    out.println();
    out.println("public boolean __caucho_create(com.caucho.amber.manager.AmberConnection aConn, com.caucho.amber.type.EntityType home)");
    out.println("  throws java.sql.SQLException");
    out.println("{");
    out.pushDepth();

    // jpa/0ge2: MappedSuperclassType
    if ((_relatedType.getTable() == null) || (_relatedType.getId() == null)) {
      out.println("return false;");

      out.popDepth();
      out.println("}");

      return;
    }

    out.println("if (__caucho_state != com.caucho.amber.entity.EntityState.P_PERSISTING)");
    out.println("  return false;");

    out.println();
    out.println("__caucho_state = com.caucho.amber.entity.EntityState.P_PERSISTED;");

    out.println();
    out.println("__caucho_cascadePrePersist(aConn);");

    int dirtyCount = _relatedType.getDirtyIndex();
    for (int i = 0; i <= dirtyCount / 64; i++) {
      out.println("__caucho_dirtyMask_" + i + " = 0L;");
    }

    Table table = _relatedType.getTable();

    String sql = _relatedType.generateCreateSQL(table);

    out.println("String sql;");

    boolean isAutoInsert = false;

    // jpa/0gg0
    if (_relatedType.getId() != null && ! isAbstract) {
      ArrayList<IdField> fields = _relatedType.getId().getKeys();
      IdField idField = fields.size() > 0 ? fields.get(0) : null;

      // jpa/0gh0
      if (idField != null
          && idField.getGenerator() != null
          && idField.getGenerator().equals("identity")) {
        isAutoInsert = true;

        out.print("sql = \"");
        out.printJavaString(_relatedType.generateAutoCreateSQL(sql));
        out.println("\";");
      }
    }

    _relatedType.getId().generateCheckCreateKey(out);

    if (! isAutoInsert) {
      out.print("sql = \"");
      out.printJavaString(sql);
      out.println("\";");
    }

    out.println();
    out.println("java.sql.PreparedStatement pstmt = aConn.prepareInsertStatement(sql);");

    out.println("int index = 1;");

    if (! isAutoInsert) {
      out.println();
      _relatedType.getId().generateSetInsert(out, "pstmt", "index");
    }

    _relatedType.generateInsertSet(out, table, "pstmt", "index", "super");

    out.println();
    out.println("pstmt.executeUpdate();");

    out.println();
    _relatedType.getId().generateSetGeneratedKeys(out, "pstmt");

    RelatedType parentType = _relatedType;

    do {
      for (Table subTable : parentType.getSecondaryTables()) {
        sql = parentType.generateCreateSQL(subTable);

        out.println();
        out.print("sql = \"");
        out.printJavaString(sql);
        out.println("\";");

        out.println("pstmt = aConn.prepareStatement(sql);");

        out.println("index = 1;");

        out.println();
        parentType.getId().generateSetInsert(out, "pstmt", "index");

        parentType.generateInsertSet(out, subTable, "pstmt", "index", "super");

        out.println();
        out.println("pstmt.executeUpdate();");

        out.println();
        parentType.getId().generateSetGeneratedKeys(out, "pstmt");
      }
    } while ((parentType = parentType.getParentType()) != null);

    // println("pstmt.close();");

    out.println("__caucho_cacheItem = new com.caucho.amber.entity.CacheableEntityItem(home.getHome(), new " + getClassName() + "());");

    out.println(getClassName() + " cacheEntity = (" + getClassName() + ") __caucho_cacheItem.getEntity();");
    out.println("cacheEntity.__caucho_home = home;");

    Id id = _relatedType.getId();

    out.println("Object pk = null;");

    if (! id.isEmbeddedId()) {

      ArrayList<IdField> keys = id.getKeys();

      for (IdField key : keys) {
        String value;

        if (keys.size() == 1)
          value = key.getType().generateCastFromObject("(pk = __caucho_getPrimaryKey())");
        else
          value = key.generateGet("super");

        out.println(key.generateSet("cacheEntity", value) + ";");
      }
    }
    else {
      // jpa/0gh0

      EmbeddableType embeddable = (EmbeddableType) id.getEmbeddedIdField().getType();

      ArrayList<AmberField> fields = embeddable.getFields();

      for (int i = 0; i < fields.size(); i++) {
        AmberField field = (AmberField) fields.get(i);

        String getter = field.getName();

        if (_relatedType.isFieldAccess())
          out.println(field.generateSet("__caucho_compound_key", getter) + ";");
        else {
          getter = Character.toUpperCase(getter.charAt(0)) +
            (getter.length() == 1 ? "" : getter.substring(1));

          String value = id.getEmbeddedIdField().generateSuperGetter() + ".get" + getter;

          // jpa/0gh0
          out.println("__caucho_compound_key.set" + getter + "(" + value + "());");
        }
      }

      out.println("pk = __caucho_compound_key;");

      out.println(id.getEmbeddedIdField().generateSet("cacheEntity", "__caucho_compound_key") + ";");
    }

    out.println("try {");
    out.pushDepth();

    // jpa/0o01
    out.println("Object child;");

    // jpa/0l21
    for (int i = 0; i <= loadCount; i++) {
      _relatedType.generateCopyLoadObject(out, "cacheEntity", "super", i);
    }

    out.popDepth();
    out.println("} catch (RuntimeException e) {");
    out.println("  throw e;");
    out.println("} catch (Exception e) {");
    out.println("  throw new com.caucho.amber.AmberRuntimeException(e);");
    out.println("}");

    parentType = _relatedType;

    // jpa/0l21
    for (int i = 0; i <= loadCount / 64; i++) {
      out.println("cacheEntity.__caucho_loadMask_" + i + " = 0L;");

      do {
        out.println("cacheEntity.__caucho_loadMask_" + i + " |= " + parentType.getCreateLoadMask(i) + ";");
      }
      while ((parentType = parentType.getParentType()) != null);
    }

    out.println();
    out.println("if (pk == null)");
    out.println("  pk = __caucho_getPrimaryKey();");

    // jpa/0i5e, jpa/1641
    // caching entity must only occur after the commit completes to
    // handle rollbacks and also so the cache doesn't have an
    // item in the middle of a transaction
    /*
      out.println();
      out.println("aConn.getPersistenceUnit().putEntity((com.caucho.amber.type.EntityType) __caucho_home.getRootType(),");
      out.println("                                     pk, __caucho_cacheItem);");
    */

    out.println();
    out.println("if (__caucho_log.isLoggable(java.util.logging.Level.FINE))");
    out.println("  __caucho_log.fine(\"amber create \" + this.getClass().getName() + \" - PK: \" + __caucho_getPrimaryKey());");
    out.println();
    out.println("if (aConn.isActiveTransaction()) {");

    // jpa/0i60
    // out.println("  __caucho_state = com.caucho.amber.entity.EntityState.P_TRANSACTIONAL;");
    out.println("  aConn.makeTransactional((com.caucho.amber.entity.Entity) this);");
    out.println("} else {");
    out.println("  __caucho_state = com.caucho.amber.entity.EntityState.P_NON_TRANSACTIONAL;");
    out.println("}");

    out.println();

    out.println();
    out.println("return false;");

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the delete
   */
  void generateDelete(JavaWriter out)
    throws IOException
  {
    out.println();
    out.println("public void __caucho_delete()");
    out.println("{");
    out.pushDepth();

    out.println("if (com.caucho.amber.entity.EntityState.P_DELETING.ordinal() <= __caucho_state.ordinal())");
    out.println("  return;");
    out.println();

    out.println("if (__caucho_home != null)");
    out.println("  __caucho_home.preRemove(this);");
    out.println();

    generateCallbacks(out, "this", _relatedType.getPreRemoveCallbacks());

    _relatedType.generatePreDelete(out);

    out.println("__caucho_state = com.caucho.amber.entity.EntityState.P_DELETING;");

    out.println("if (__caucho_session != null) {");
    out.pushDepth();
    out.println("__caucho_session.update((com.caucho.amber.entity.Entity) this);");
    out.println("__caucho_home.getTable().beforeEntityDelete(__caucho_session, (com.caucho.amber.entity.Entity) this);");
    out.println("__caucho_state = com.caucho.amber.entity.EntityState.P_DELETED;");
    _relatedType.generatePostDelete(out);
    out.popDepth();
    out.println("}");
    out.println("else");
    out.println("  __caucho_state = com.caucho.amber.entity.EntityState.P_DELETED;");

    out.popDepth();
    out.println("}");

    Id id = _relatedType.getId();

    out.println();
    out.println("private void __caucho_delete_int()");
    out.println("  throws java.sql.SQLException");
    out.println("{");
    out.pushDepth();

    // jpa/0ge2: MappedSuperclassType
    if ((_relatedType.getTable() == null) || (id == null)) {
      out.println("return;");

      out.popDepth();
      out.println("}");

      return;
    }

    out.println("java.sql.PreparedStatement pstmt = null;");
    out.println("String sql = null;");
    out.println();

    out.println("try {");
    out.pushDepth();

    out.print("__caucho_home.delete(__caucho_session, ");
    out.print(id.toObject(id.generateGetProperty("this")));
    out.println(");");

    out.println("__caucho_session.removeEntity((com.caucho.amber.entity.Entity) this);");

    String table = _relatedType.getTable().getName();
    String where = _relatedType.getId().generateMatchArgWhere(null);

    String sql = ("delete from " + table + " where " + where);

    out.print("sql = \"");
    out.printJavaString(sql);
    out.println("\";");

    out.println();
    out.println("pstmt = __caucho_session.prepareStatement(sql);");

    out.println("int index = 1;");
    id.generateSet(out, "pstmt", "index", "this");

    out.println();
    out.println("pstmt.executeUpdate();");

    out.println("__caucho_home.postRemove(this);");

    generateCallbacks(out, "this", _relatedType.getPostRemoveCallbacks());

    out.popDepth();
    out.println("} catch (Exception e) {");
    out.println("  if (pstmt != null)");
    out.println("    __caucho_session.closeStatement(sql);");
    out.println();
    out.println("  if (e instanceof java.sql.SQLException)");
    out.println("    throw (java.sql.SQLException) e;");
    out.println();
    out.println("  if (e instanceof RuntimeException)");
    out.println("    throw (RuntimeException) e;");
    out.println();
    out.println("  throw new com.caucho.amber.AmberRuntimeException(e);");
    out.println("}");

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the foreign delete
   */
  void generateDeleteForeign(JavaWriter out)
    throws IOException
  {
    out.println();
    out.println("public void __caucho_invalidate_foreign(String table, Object key)");
    out.println("{");
    out.pushDepth();

    _relatedType.generateInvalidateForeign(out);

    out.popDepth();
    out.println("}");
  }


  /**
   * Generates the cache load
   */
  void generateLoadFromObject(JavaWriter out,
                              boolean isEntityParent)
    throws IOException
  {
    out.println();
    out.println("public void __caucho_loadFromObject(Object src)");
    out.println("{");
    out.pushDepth();

    out.println(getClassName() + " o = (" + getClassName() + ") src;");

    if (isEntityParent)
      out.println("super.__caucho_loadFromObject(src);");
    else {
      int loadCount = _relatedType.getLoadGroupIndex();
      for (int i = 0; i <= loadCount / 64; i++) {
        out.println("__caucho_loadMask_" + i + " = o.__caucho_loadMask_" + i + ";");
      }
    }

    int dirtyCount = _relatedType.getDirtyIndex();
    for (int i = 0; i <= dirtyCount / 64; i++) {
      out.println("__caucho_dirtyMask_" + i + " = 0;");
    }

    _relatedType.generateLoadFromObject(out, "o");

    /* XXX:
       if (Lifecycle.class.isAssignableFrom(_relatedType.getBeanClass())) {
       println("if (src instanceof com.caucho.ormap.Lifecycle)");
       println("  ((com.caucho.ormap.Lifecycle) src).afterLoad(__caucho_session, " +
       _relatedType.getId().getGetterName() + "());");
       }
    */

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the copy
   */
  /*
    void generateCopy(JavaWriter out)
    throws IOException
    {
      out.println();
      out.println("public com.caucho.amber.entity.Entity __caucho_copy()");
      out.println("{");
      out.pushDepth();

      out.println(getClassName() + " o = new " + getClassName() + "();");

      // can't load because it doesn't handle timeouts
      out.println("o.__caucho_loadFromObject((com.caucho.amber.entity.Entity) this);");
      out.println("o.__caucho_loadMask = 0;");

      out.println("return o;");

      out.popDepth();
      out.println("}");
    }
  */

  /**
   * Generates the create
   */
  void generateCopy(JavaWriter out)
    throws IOException
  {
    out.println();
    out.println("public com.caucho.amber.entity.Entity __caucho_copy(com.caucho.amber.manager.AmberConnection aConn,");
    out.println("                                                    com.caucho.amber.entity.EntityItem item)");
    out.println("{");
    out.pushDepth();

    out.println(getClassName() + " o = new " + getClassName() + "();");

    out.println();
    out.println("return __caucho_copyTo((com.caucho.amber.entity.Entity) o, aConn, item);");

    out.popDepth();
    out.println("}");

    out.println();
    out.println("public com.caucho.amber.entity.Entity __caucho_copyTo(com.caucho.amber.entity.Entity targetEntity,");
    out.println("                                                      com.caucho.amber.manager.AmberConnection aConn,");
    out.println("                                                      com.caucho.amber.entity.EntityItem cacheItem)");
    out.println("{");
    out.pushDepth();

    out.println(getClassName() + " o = (" + getClassName() + ") targetEntity;");

    out.println("o.__caucho_cacheItem = cacheItem;");
    out.println();
    out.println("this.__caucho_copyTo((com.caucho.amber.entity.Entity) o, aConn);");

    out.println("o.__caucho_session = aConn;");
    out.println("o.__caucho_state = __caucho_state;"); // com.caucho.amber.entity.Entity.P_NON_TRANSACTIONAL;");

    for (int i = 0; i <= _relatedType.getLoadGroupIndex() / 64; i++) {
      String mask = "__caucho_loadMask_" + i;

      out.println("o." + mask + " = " + mask + ";");
    }

    int dirtyCount = _relatedType.getDirtyIndex();

    // jpa/0g06
    for (int i = 0; i <= dirtyCount / 64; i++) {
      String mask = "__caucho_dirtyMask_" + i;

      out.println("o." + mask + " = 0L;");
    }

    // jpa/0r00 vs. jpa/0r01
    // It will only copyTo() within a transaction if
    // the cache item is new, i.e. the very first load.
    out.println();
    out.println("if (! aConn.isActiveTransaction()) {");
    out.pushDepth();

    out.println("__caucho_home.postLoad(targetEntity);");

    // jpa/0r00: @PostLoad, without transaction.
    // When there is no transaction the entity is copied
    // directly from cache. The cache copy is the object
    // that is loaded in __caucho_load() and we cannot call
    // postLoad() there. After copyTo(), the targetEntity
    // has been loaded into the current persistence context
    // and it is safe to call the post load callbacks.
    generateCallbacks(out, "o", _relatedType.getPostLoadCallbacks());

    out.popDepth();
    out.println("}");

    out.println();
    out.println("return (com.caucho.amber.entity.Entity) o;");

    out.popDepth();
    out.println("}");

    out.println();
    out.println("public void __caucho_copyTo(com.caucho.amber.entity.Entity targetEntity,");
    out.println("                            com.caucho.amber.manager.AmberConnection aConn)");
    out.println("{");
    out.pushDepth();

    out.println("__caucho_copyTo(targetEntity, aConn, false);");

    out.popDepth();
    out.println("}");

    out.println();
    out.println("public void __caucho_copyTo(com.caucho.amber.entity.Entity targetEntity,");
    out.println("                            com.caucho.amber.manager.AmberConnection aConn,");
    out.println("                            boolean isFullMerge)");
    out.println("{");
    out.pushDepth();

    out.println("if (this == targetEntity)");
    out.println("  return;");
    out.println();

    out.println(getClassName() + " o = (" + getClassName() + ") targetEntity;");

    out.println("if (o.__caucho_home == null)");
    out.println("  o.__caucho_home = __caucho_home;");

    // jpa/0ge6: MappedSuperclass
    if (_relatedType.getId() != null) {
      ArrayList<IdField> keys = _relatedType.getId().getKeys();

      for (int i = 0; i < keys.size(); i++) {
        IdField key = keys.get(i);

        out.println(key.generateSet("o", key.generateGet("super")) + ";");
      }
    }

    out.println("try {");
    out.pushDepth();

    // jpa/0o01
    out.println("Object child;");

    for (int i = 0; i <= _relatedType.getLoadGroupIndex(); i++) {
      // jpa/0l02
      _relatedType.generateCopyLoadObject(out, "o", "super", i);
    }

    out.popDepth();
    out.println("} catch (RuntimeException e) {");
    out.println("  throw e;");
    out.println("} catch (Exception e) {");
    out.println("  throw new com.caucho.amber.AmberRuntimeException(e);");
    out.println("}");

    out.popDepth();
    out.println("}");

    out.println();
    out.println("public void __caucho_merge(com.caucho.amber.entity.Entity targetEntity,");
    out.println("                           com.caucho.amber.manager.AmberConnection aConn,");
    out.println("                           boolean isFullMerge)");
    out.println("{");
    out.pushDepth();

    out.println("if (isFullMerge)");
    out.println("  this.__caucho_copyTo(targetEntity, aConn, true);");
    out.println();

    out.println(getClassName() + " other = (" + getClassName() + ") targetEntity;");

    for (int i = 0; i <= _relatedType.getLoadGroupIndex(); i++) {
      _relatedType.generateCopyMergeObject(out, "other", "super", i);
    }

    out.println();
    out.println("try {");
    out.pushDepth();

    // jpa/1622
    out.println("targetEntity.__caucho_cascadePostPersist(aConn);");

    out.popDepth();
    out.println("} catch (java.sql.SQLException e) {");
    out.println("  throw new com.caucho.amber.AmberRuntimeException(e);");
    out.println("}");

    out.popDepth();
    out.println("}");

    out.println();
    out.println("public void __caucho_copyDirtyMaskFrom(com.caucho.amber.entity.Entity sourceEntity)");
    out.println("{");
    out.pushDepth();

    out.println(getClassName() + " o = (" + getClassName() + ") sourceEntity;");

    for (int i = 0; i <= dirtyCount / 64; i++) {
      out.println("__caucho_dirtyMask_" + i + " = o.__caucho_dirtyMask_" + i + ";");
    }

    out.popDepth();
    out.println("}");

    out.println();
    out.println("public void __caucho_copyLoadMaskFrom(com.caucho.amber.entity.Entity sourceEntity)");
    out.println("{");
    out.pushDepth();

    out.println(getClassName() + " o = (" + getClassName() + ") sourceEntity;");

    int loadCount = _relatedType.getLoadGroupIndex();

    for (int i = 0; i <= loadCount / 64; i++) {
      out.println("__caucho_loadMask_" + i + " = o.__caucho_loadMask_" + i + ";");
    }

    out.popDepth();
    out.println("}");
  }

  void generateSetLoadMask(JavaWriter out)
    throws IOException
  {
    out.println();
    out.println("public long __caucho_getLoadMask(int loadGroup)");
    out.println("{");
    out.pushDepth();

    out.println("switch (loadGroup) {");
    out.pushDepth();

    int loadCount = _relatedType.getLoadGroupIndex();

    for (int i = 0; i <= loadCount / 64; i++) {
      out.println("case " + i + ":");
      out.println("  return __caucho_loadMask_" + i + ";");
    }

    out.popDepth();
    out.println("}");

    out.println("return 0;");

    out.popDepth();
    out.println("}");

    out.println();
    out.println("public void __caucho_setLoadMask(long loadMask, int loadGroup)");
    out.println("{");
    out.pushDepth();

    out.println("switch (loadGroup) {");
    out.pushDepth();

    for (int i = 0; i <= loadCount / 64; i++) {
      out.println("case " + i + ":");
      out.println("  __caucho_loadMask_" + i + " = loadMask;");
      out.println("  break;");
    }

    out.popDepth();
    out.println("}");

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the copy
   */
  void generateMakePersistent(JavaWriter out)
    throws IOException
  {
    out.println();
    out.println("public void __caucho_makePersistent(com.caucho.amber.manager.AmberConnection aConn,");
    out.println("                                    com.caucho.amber.entity.EntityItem cacheItem)");
    out.println("{");
    out.pushDepth();

    out.println(_extClassName + " entity = (" + _extClassName + ") cacheItem.getEntity();");

    out.println("__caucho_home = entity.__caucho_home;");
    out.println("if (__caucho_home == null) throw new NullPointerException();");
    out.println("__caucho_cacheItem = cacheItem;");

    // jpa/0ge6: MappedSuperclass
    if (_relatedType.getId() != null) {
      ArrayList<IdField> keys = _relatedType.getId().getKeys();

      for (int i = 0; i < keys.size(); i++) {
        IdField key = keys.get(i);

        out.println(key.generateSet("super", key.generateGet("entity")) + ";");
      }
    }

    out.println("__caucho_session = aConn;");

    // out.println("if (__caucho_state != com.caucho.amber.entity.EntityState.P_TRANSACTIONAL) {");
    out.println("__caucho_state = com.caucho.amber.entity.EntityState.P_NON_TRANSACTIONAL;");
    // out.println("}");

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the cascade persist
   */
  void generateCascadePersist(JavaWriter out)
    throws IOException
  {
    out.println();
    out.println("public void __caucho_cascadePrePersist(com.caucho.amber.manager.AmberConnection aConn)");
    out.println("  throws java.sql.SQLException");
    out.println("{");
    out.pushDepth();

    // jpa/0i60
    /*
      out.println("if (__caucho_state == com.caucho.amber.entity.EntityState.P_TRANSACTIONAL)");
      out.println("  __caucho_state = com.caucho.amber.entity.EntityState.P_PERSIST;");
    */

    // out.println("if (aConn == null)");
    // out.println("  throw new com.caucho.amber.AmberException(\"Null AmberConnection when object \" + " + getDebug() + " + \" is trying to cascade persist child objects.\");");

    ArrayList<AmberField> fields = _relatedType.getFields();

    for (int i = 0; i < fields.size(); i++) {
      AmberField field = fields.get(i);

      if (field.isCascadable()) {
        CascadableField cascadable = (CascadableField) field;

        out.println();

        cascadable.generatePreCascade(out, "aConn", CascadeType.PERSIST);
      }
    }

    out.popDepth();
    out.println("}");

    out.println();
    out.println("public void __caucho_cascadePostPersist(com.caucho.amber.manager.AmberConnection aConn)");
    out.println("  throws java.sql.SQLException");
    out.println("{");
    out.pushDepth();

    for (int i = 0; i < fields.size(); i++) {
      AmberField field = fields.get(i);

      if (field.isCascadable()) {
        CascadableField cascadable = (CascadableField) field;

        out.println();

        cascadable.generatePostCascade(out, "aConn", CascadeType.PERSIST);
      }
    }

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the cascade remove
   */
  void generateCascadeRemove(JavaWriter out)
    throws IOException
  {
    out.println();
    out.println("public void __caucho_cascadePreRemove(com.caucho.amber.manager.AmberConnection aConn)");
    out.println("  throws java.sql.SQLException");
    out.println("{");
    out.pushDepth();

    ArrayList<AmberField> fields = _relatedType.getFields();

    for (int i = 0; i < fields.size(); i++) {
      AmberField field = fields.get(i);

      if (field.isCascadable()) {
        CascadableField cascadable = (CascadableField) field;

        out.println();

        cascadable.generatePreCascade(out, "aConn", CascadeType.REMOVE);
      }
    }

    out.popDepth();
    out.println("}");

    out.println();
    out.println("public void __caucho_cascadePostRemove(com.caucho.amber.manager.AmberConnection aConn)");
    out.println("  throws java.sql.SQLException");
    out.println("{");
    out.pushDepth();

    for (int i = 0; i < fields.size(); i++) {
      AmberField field = fields.get(i);

      if (field.isCascadable()) {
        CascadableField cascadable = (CascadableField) field;

        out.println();

        cascadable.generatePostCascade(out, "aConn", CascadeType.REMOVE);
      }
    }

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the home methods
   */
  void generateHome(JavaWriter out)
    throws IOException
  {
    generateHomeFind(out);

    boolean generateHomeNew = true;

    // jpa/0ge2
    if (_relatedType instanceof MappedSuperclassType)
      generateHomeNew = false;

    /* XXX
       if (_relatedType instanceof SubEntityType) {
         SubEntityType sub = (SubEntityType) _relatedType;

         // jpa/0ge2
         if (! sub.isParentMappedSuperclass()) {
           if (! sub.getParentType().isAbstractClass())
             generateHomeNew = false;
         }
       }
    */

    if (generateHomeNew) {
      generateHomeNew(out);
      generateHomeFindNew(out);
    }
  }

  /**
   * Generates the load key.
   */
  void generateLoadKey(JavaWriter out)
    throws IOException
  {
    out.println();
    out.print("public Object __caucho_load_key(");
    out.print("com.caucho.amber.manager.AmberConnection aConn,");
    out.println("java.sql.ResultSet rs, int index)");
    out.println("  throws java.sql.SQLException");
    out.println("{");
    out.pushDepth();

    boolean isAbstract = (_relatedType.getBeanClass().isAbstract()
                          && _relatedType.getPersistenceUnit().isJPA());

    // jpa/0gg0
    if (_relatedType.getId() == null || isAbstract) {
      // jpa/0ge6: MappedSuperclass

      out.println("return null;");
      out.popDepth();
      out.println("}");

      return;
    }

    out.print("return ");
    int index = _relatedType.getId().generateLoadForeign(out, "rs", "index", 0);
    out.println(";");

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the home methods
   */
  void generateHomeFind(JavaWriter out)
    throws IOException
  {
    out.println();
    out.print("public com.caucho.amber.entity.EntityItem __caucho_home_find(");
    out.print("com.caucho.amber.manager.AmberConnection aConn,");
    out.print("com.caucho.amber.entity.AmberEntityHome home,");
    out.println("java.sql.ResultSet rs, int index)");
    out.println("  throws java.sql.SQLException");
    out.println("{");
    out.pushDepth();

    boolean isAbstract = (_relatedType.getBeanClass().isAbstract()
                          && _relatedType.getPersistenceUnit().isJPA());

    if (_relatedType.getId() == null || isAbstract) {
      // jpa/0ge6: MappedSuperclass

      out.println("return null;");
      out.popDepth();
      out.println("}");

      return;
    }

    out.print("Object key = ");
    int index = _relatedType.getId().generateLoadForeign(out, "rs", "index", 0);
    out.println(";");

    if (_relatedType.getDiscriminator() == null) {
      out.println("return aConn.loadCacheItem(home.getJavaClass(), key, home);");
    }
    else {
      out.println("String discriminator = rs.getString(index + " + index + ");");
      out.println();
      out.println("return home.findDiscriminatorEntityItem(aConn, key, discriminator);");
    }

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the home methods
   */
  /*
    void generateHomeNew(JavaWriter out)
    throws IOException
    {
    out.println();
    out.print("public com.caucho.amber.entity.Entity __caucho_home_new(");
    out.print("com.caucho.amber.manager.AmberConnection aConn,");
    out.print("com.caucho.amber.entity.AmberEntityHome home,");
    out.print("Object key)");
    out.println("  throws java.sql.SQLException");
    out.println("{");
    out.println("  return __caucho_home_new(aConn, home, key, true);");
    out.println("}");

    out.println();
    out.print("public com.caucho.amber.entity.Entity __caucho_home_new(");
    out.print("com.caucho.amber.manager.AmberConnection aConn,");
    out.print("com.caucho.amber.entity.AmberEntityHome home,");
    out.print("Object key,");
    out.print("boolean loadFromResultSet)");
    out.println("  throws java.sql.SQLException");
    out.println("{");
    out.pushDepth();

    if (_relatedType.isAbstractClass() || _relatedType.getId() == null) {
    out.println("return null;");
    out.popDepth();
    out.println("}");
    return;
    }

    String rootTableName = _relatedType.getRootTableName();

    if (rootTableName == null)
    rootTableName = "";

    out.println("java.sql.ResultSet rs" + rootTableName + " = null;");
    out.println("java.sql.PreparedStatement pstmt" + rootTableName + " = null;");
    out.println("String sql" + rootTableName + " = null;");
    out.println();
    out.println("try {");
    out.pushDepth();

    Column discriminator = _relatedType.getDiscriminator();

    if (discriminator == null) {
    // Adds the copy object to the context before anything.
    // This will avoid the cache object to be added to the context.
    out.println("com.caucho.amber.entity.Entity copy = aConn.addNewEntity(" + getClassName() + ".class, key);");

    out.println(getClassName() + " entity = (" + getClassName() + ") __caucho_home_new();");

    out.println("entity.__caucho_home = home.getEntityType();");
    out.println("entity.__caucho_setPrimaryKey(key);");

    /*
    out.println();
    out.println("if (copy == null) {");
    out.pushDepth();

    // jpa/0l42: eagerly loading optimization.
    out.println("copy = aConn.getEntity(entity);");

    out.println("((com.caucho.amber.entity.Entity) entity).__caucho_copyLoadMaskFrom(copy);");

    // jpa/0o05
    out.println("copy.__caucho_copyTo(((com.caucho.amber.entity.Entity) entity), aConn);");

    out.popDepth();
    out.println("}");
    out.println();

    out.println("return (com.caucho.amber.entity.Entity) entity;");
    }
    else {
    // jpa/0l40: inheritance optimization.
    out.println("try {");

    String keyType = _relatedType.getId().getForeignTypeName();

    out.println("  __caucho_session = aConn;");
    out.println("  __caucho_loadMask_0 = 0L;");
    out.println("  __caucho_cacheItem = null;");
    out.println();
    out.println("  __caucho_setPrimaryKey((" + keyType + ") key);");
    out.println("  __caucho_load_0(aConn);");
    out.println("} catch (com.caucho.amber.AmberObjectNotFoundException e) {");
    out.println("  return null;");
    out.println("}");

    // generateHomeNewLoading(out, rootTableName);

    out.println("com.caucho.amber.entity.EntityItem item = home.findDiscriminatorEntityItem(aConn, key, __caucho_discriminator);"); // rs" + rootTableName + ".getString(1));");

    // Adds the copy object to the context before anything.
    // This will avoid the cache object to be added to the context.
    out.println("com.caucho.amber.entity.Entity copy = aConn.addNewEntity(item.getEntity().getClass(), key);");

    out.println();
    out.println("if (copy == null) {");
    out.pushDepth();

    // jpa/0l47: eagerly loading optimization.
    out.println("copy = aConn.getEntity(cacheItem.getEntity());");

    out.println("item.getEntity().__caucho_copyLoadMaskFrom(copy);");

    // jpa/0o05
    out.println("copy.__caucho_copyTo(item.getEntity(), aConn);");

    out.popDepth();
    out.println("}");
    out.println();

    // jpa/0l03
    out.println("if (loadFromResultSet) {");
    out.pushDepth();

    // generateHomeNewLoading(out, null);

    out.println("item.getEntity().__caucho_load(aConn, rs" + rootTableName + ", 1);");

    out.popDepth();
    out.println("}");

    // jpa/0l40
    out.println("item.getEntity().__caucho_setLoadMask(1L, 0);");
    out.println("__caucho_copyTo(item.getEntity(), aConn, true);");

    // jpa/0l00
    // out.println(getClassName() + " entity = (" + getClassName() + ") item.copy(aConn);");
    // out.println("return (com.caucho.amber.entity.Entity) entity;");

    out.println("return (com.caucho.amber.entity.Entity) item.getEntity();");
    }

    out.popDepth();
    out.println("} catch (Exception e) {");
    out.println("  if (pstmt" + rootTableName + " != null)");
    out.println("    aConn.closeStatement(sql" + rootTableName + ");");
    out.println();
    out.println("  if (e instanceof java.sql.SQLException)");
    out.println("    throw (java.sql.SQLException) e;");
    out.println();
    out.println("  if (e instanceof RuntimeException)");
    out.println("    throw (RuntimeException) e;");
    out.println();
    out.println("  throw new com.caucho.amber.AmberRuntimeException(e);");
    out.println("}");
    out.println("finally {");
    out.println("  if (rs" + rootTableName + " != null)");
    out.println("    rs" + rootTableName + ".close();");
    out.println("}");

    out.popDepth();
    out.println("}");

    out.println();
    out.print("protected com.caucho.amber.entity.Entity __caucho_home_new()");
    out.println("{");
    out.println("  return new " + getClassName() + "();");
    out.println("}");
    }
  */

  void generateHomeNew(JavaWriter out)
    throws IOException
  {
    out.println();
    out.print("public com.caucho.amber.entity.Entity __caucho_home_new(");
    out.print("com.caucho.amber.entity.AmberEntityHome home");
    out.println(", Object key");
    out.println(", AmberConnection aConn");
    out.println(", EntityItem cacheItem");
    out.println(")");
    out.println("{");
    out.pushDepth();

    if (_relatedType.isAbstractClass() || _relatedType.getId() == null) {
      out.println("return null;");
      out.popDepth();
      out.println("}");
      return;
    }

    out.println(getClassName() + " entity = new " + getClassName() + "();");

    out.println("entity.__caucho_home = home.getEntityType();");
    out.println("entity.__caucho_setPrimaryKey(key);");
    out.println("entity.__caucho_session = aConn;");
    out.println("entity.__caucho_cacheItem = cacheItem;");

    out.println("return entity;");

    out.popDepth();
    out.println("}");
  }

  void generateHomeFindNew(JavaWriter out)
    throws IOException
  {
    RelatedType parentType = _relatedType.getParentType();

    // jpa/0ge3
    // jpa/0l32: find(SubBean.class, "2") would try to select the
    // discriminator column from the "sub-table".
    if (parentType != null
        && (parentType instanceof EntityType)
        && ! parentType.isAbstractClass()) {
      return;
    }

    out.println();
    out.print("public com.caucho.amber.entity.Entity __caucho_home_find(");
    out.print("com.caucho.amber.manager.AmberConnection aConn, ");
    out.print("com.caucho.amber.entity.AmberEntityHome home, ");
    out.println("Object key)");
    out.println("{");
    out.pushDepth();

    Column discriminator = _relatedType.getDiscriminator();

    if (_relatedType.isAbstractClass()
        || _relatedType.getId() == null
        || discriminator == null) {
      out.println("return __caucho_home_new(home, key, aConn, null);");
      out.popDepth();
      out.println("}");
      return;
    }

    String rootTableName = _relatedType.getRootTableName();

    if (rootTableName == null)
      rootTableName = "";

    out.println("java.sql.ResultSet rs = null;");
    out.println("java.sql.PreparedStatement pstmt = null;");
    out.println("String sql = null;");
    out.println();
    out.println("try {");
    out.pushDepth();

    String keyType = _relatedType.getId().getForeignTypeName();

    String discriminatorVar = "discriminator";

    out.println("String " + discriminatorVar + " = null;");

    generateHomeNewLoading(out, discriminatorVar);

    out.println("com.caucho.amber.entity.Entity entity = home.newDiscriminatorEntity(key, " + discriminatorVar + ");");

    out.println("entity.__caucho_load(aConn, rs, 1);");

    out.println("return entity;");

    out.popDepth();
    out.println("} catch (RuntimeException e) {");
    out.println("  throw e;");
    out.println("} catch (Exception e) {");
    out.println("  throw new com.caucho.amber.AmberRuntimeException(e);");
    out.println("} finally {");
    /*
      out.println("  if (rs != null)");
      out.println("    rs.close();");
      out.println("  if (pstmt != null)");
      out.println("    aConn.closeStatement(sql);");
    */
    out.println("}");

    out.popDepth();
    out.println("}");
  }

  /**
   * Generates the loading for home_new
   */
  void generateHomeNewLoading(JavaWriter out,
                              String discriminatorVar)
    throws IOException
  {
    out.print("sql = \"select ");

    RelatedType parentType = _relatedType;

    /* XXX: jpa/0gg3
    // jpa/0l32
    if (_relatedType.getDiscriminator() != null) {
      while (parentType.getParentType() != null)
        parentType = parentType.getParentType();
    }
    */

    out.printJavaString(parentType.generateLoadSelect("o"));
    out.print(" from ");

    /*
      if (rootTableName == null)
        out.print(_relatedType.getTable().getName());
      else
        out.print(rootTableName);
    */
    out.printJavaString(_relatedType.getTable().getName());

    out.print(" o where ");
    // jpa/0s27
    out.printJavaString((parentType.getId().generateMatchArgWhere("o")));
    out.println("\";");

    out.println("pstmt = aConn.prepareStatement(sql);");

    String keyType = _relatedType.getId().getForeignTypeName();

    out.println(keyType + " " + "keyValue = (" + keyType + ") key;");

    out.println("int index = 1;");
    _relatedType.getId().generateSetKey(out, "pstmt", "index", "keyValue");

    out.println("rs = pstmt.executeQuery();");
    out.println("if (rs.next()) {");
    out.println("  " + discriminatorVar + " = rs.getString(1);"); // XXX:

    out.println("}");
  }

  void generateCallbacks(JavaWriter out,
                         String object,
                         ArrayList<JMethod> callbacks)
    throws IOException
  {
    if (callbacks.size() > 0) {

      out.println();

      for (JMethod method : callbacks) {
        out.println(object + "." + method.getName() + "();");
      }
    }
  }

  void generateInternals(JavaWriter out)
    throws IOException
  {
    out.println();
    out.println("private void __caucho_setInternalString(java.sql.PreparedStatement pstmt, int index, String s)");
    out.println("  throws java.sql.SQLException");
    out.println("{");
    out.pushDepth();
    out.println("if (s == null)");
    out.println("  pstmt.setNull(index, java.sql.Types.NULL);");
    out.println("else");
    out.println("  pstmt.setString(index, s);");
    out.popDepth();
    out.println("}");
  }
}
