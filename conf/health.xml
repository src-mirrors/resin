<cluster xmlns="http://caucho.com/ns/resin"
         xmlns:resin="urn:java:com.caucho.resin"
         xmlns:health="urn:java:com.caucho.health"
         xmlns:ee="urn:java:ee">

  <!--
     - Health monitoring system default configuration
    -->
         
  <health:HealthSystem>
    <enabled>true</enabled>
    <delay>15m</delay>
    <period>5m</period>
    <recheckPeriod>15s</recheckPeriod>
    <recheckMax>5</recheckMax>
  </health:HealthSystem>

  <!--
     - Restart immediately if deadlock is detected
    -->
  
  <health:JvmDeadlockHealthCheck ee:Named="JvmDeadlockHealthCheck"/>
  
  <health:Restart>
    <health:IfHealthCritical healthCheck="${JvmDeadlockHealthCheck}"/>
  </health:Restart>

  <!--
     - Dump heap and restart if memory pools are critically low 
    -->
  
  <health:MemoryTenuredHealthCheck ee:Named="MemoryTenuredHealthCheck">
    <memoryFreeMin>1m</memoryFreeMin>
  </health:MemoryTenuredHealthCheck>
  
  <health:MemoryPermGenHealthCheck ee:Named="MemoryPermGenHealthCheck">
    <memoryFreeMin>1m</memoryFreeMin>
  </health:MemoryPermGenHealthCheck>
  
  <health:DumpHeap>
    <health:Or>
      <health:IfHealthCritical healthCheck="${MemoryTenuredHealthCheck}"/>
      <health:IfHealthCritical healthCheck="${MemoryPermGenHealthCheck}"/>
    </health:Or>
    <health:IfRechecked/>
  </health:DumpHeap>
  
  <health:Restart>
    <health:Or>
      <health:IfHealthCritical healthCheck="${MemoryTenuredHealthCheck}"/>
      <health:IfHealthCritical healthCheck="${MemoryPermGenHealthCheck}"/>
    </health:Or>
    <health:IfRechecked/>
  </health:Restart>
  
  <!--
     - Dump active threads and restart if cpu usage is critically high
    -->

  <health:CpuHealthCheck ee:Named="CpuHealthCheck">
    <warningThreshold>95</warningThreshold>
    <criticalThreshold>99</criticalThreshold>
  </health:CpuHealthCheck>
  
  <health:DumpThreads>
    <health:IfHealthCritical healthCheck="${CpuHealthCheck}"/>
    <health:IfRechecked/>
  </health:DumpThreads>
  
  <health:Restart>
    <health:IfHealthCritical healthCheck="${CpuHealthCheck}"/>
    <health:IfRechecked/>
  </health:Restart>
  
  <!--
     - Log missing or delayed cluster member heartbeats
    -->

  <health:HeartbeatHealthCheck ee:Named="HeartbeatHealthCheck"/>

  <!--
     - Log connection pool limits reached
    -->

  <health:ConnectionPoolHealthCheck ee:Named="ConnectionPoolHealthCheck"/>
  
  <!--
     - Log transaction manager commit failures 
    -->

  <health:TransactionHealthCheck ee:Named="TransactionHealthCheck"/>
  
  <!--
     - Restart if any health checks are frozen or threads are hung 
    -->
    
  <health:HealthSystemHealthCheck ee:Named="HealthSystemHealthCheck"/>
  
  <health:Restart>
    <health:IfHealthCritical healthCheck="${HealthSystemHealthCheck}"/>
    <health:IfRechecked/>
  </health:Restart>
  
</cluster>
