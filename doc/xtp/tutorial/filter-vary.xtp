<document>
  <header>
    <product>resin</product>
    <resin-2.0>$resin/java_tut/filter-vary.xtp</resin-2.0>
    <title>Servlet Filter with XTP -- Vary</title>
    <description>
      <p>This example uses a servlet filter to select the stylesheet
        that is used for XTP pages.  If the user adds the style=plain query, the page will
        use a plain stylesheet.  Otherwise the page will use a fancy
        stylesheet.</p>

      <p>The Servlet 2.3 specification creates a new way to control
        servlets: filters.  Filters can inspect and modify the request or
        response before and after passing the request to the servlet.</p>

      <p>The filter itself just looks at the "style" parameter.  If it's
        "plain", then the filter will set the <var>caucho.xsl.stylesheet</var>
        parameter to <var>plain.xsl</var>.  XTP uses
        <var>caucho.xsl.stylesheet</var> when it transforms the page.</p>
    </description>
  </header>

  <body>
    <summary/>

<example title="test.VaryFilter.java">
package test;

import java.io.*;
import javax.servlet.*;
import javax.servlet.http.*;

public class VaryFilter implements Filter {
  private FilterConfig config;

  public void init(FilterConfig config)
  {
    this.config = config;
  }

  public void doFilter(ServletRequest request,
                       ServletResponse response,
                       FilterChain next)
    throws IOException, ServletException
  {
    HttpServletRequest req = (HttpServletRequest) request;

    String style = req.getParameter("style");

    if ("plain".equals(style))
      req.setAttribute("caucho.xsl.stylesheet", "plain.xsl");
    else
      req.setAttribute("caucho.xsl.stylesheet", "default.xsl");

    next.doFilter(request, response);
  }

  public void destroy()
  {
  }
}
</example>

<example title="web.xml">
&lt;web-app&gt;
  &lt;filter-mapping url-pattern='*.xtp'
                  filter-name='test.VaryFilter'/&gt;
&lt;/web-app&gt;
</example>

<p>The sample Serif page has a small section and some content.  It's
parsed as HTML before using the stylesheets.  The default stylesheet
will color the section header red.  The plain stylesheet leaves it as
black.</p>

<example title="test.xtp">
&lt;title&gt;A Sample Title&lt;/title&gt;

&lt;s1 title="A Sample Section"&gt;

Some content in the sample section.

&lt;/s1&gt;
</example>

<p>Unknown tags are copied from the Serif page to the generated HTML
page unchanged.  So you can just add rules for tags you want to
change.  The example forces the background of the body to white and
formats a section with an H3 header colored red.</p>

<example title="default.xsl">
&lt;xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
                version="1.0"&gt;

  &lt;!-- make sure '&lt;' is not printed as '&amp;lt;' --&gt;
  &lt;xsl:output disable-output-escaping='true'/&gt;

  &lt;!-- copy input to output --&gt;
  &lt;xsl:template match='*|@*'&gt;
    &lt;xsl:copy&gt;
      &lt;xsl:apply-templates select='node()|@*'/&gt;
    &lt;/xsl:copy&gt;
  &lt;/xsl:template&gt;

  &lt;xsl:template match="body"&gt;
    &lt;body bgcolor=white&gt;
      &lt;xsl:apply-templates/&gt;
    &lt;/body&gt;
  &lt;/xsl:template&gt;

  &lt;xsl:template match="s1"&gt;
    &lt;h3&gt;&lt;font color=red&gt;&lt;xsl:value-of select="@title"/&gt;&lt;/font&gt;&lt;/h3&gt;
    &lt;xsl:apply-templates/&gt;
  &lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</example>

<p>The plain stylesheet leaves the Serif page untouched except for
converting the section title to use plain H3.</p>

<example title="plain.xsl">
&lt;xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform"
                version="1.0"&gt;

  &lt;!-- make sure '&lt;' is not printed as '&amp;lt;' --&gt;
  &lt;xsl:output disable-output-escaping='true'/&gt;

  &lt;!-- copy input to output --&gt;
  &lt;xsl:template match='*|@*'&gt;
    &lt;xsl:copy&gt;
      &lt;xsl:apply-templates select='node()|@*'/&gt;
    &lt;/xsl:copy&gt;
  &lt;/xsl:template&gt;

  &lt;xsl:template match="s1"&gt;
    &lt;h3&gt;&lt;xsl:value-of select="@title"/&gt;&lt;/h3&gt;
    &lt;xsl:apply-templates/&gt;
  &lt;/xsl:template&gt;
&lt;/xsl:stylesheet&gt;
</example>
  </body>
</document>