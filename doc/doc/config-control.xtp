<document>
<header>
  <product>resin</product>
  <title>Control structures, EL Variables, and Functions</title>
  <description>
  <p>
  Resin's configuration files support JSP EL expressions in
  several contexts, basic control structures for conditional processing, and
  several useful functions.</p>
  </description>
</header>

<body>
<localtoc/>

<s1 name="vars" title="Environment Variables">

<p>Each Environment in Resin has an associated set of EL objects and
functions.  The EL Environment is inherited, the objects available in
<code>host</code> are also available in <code>web-app</code>.</p>

<example title="host regexp">
&lt;host regexp="www.([^.]+).com"&gt;
  &lt;root-directory&gt;/opt/www/${'${'}host.regexp[1]}&lt;/root-directory&gt;

  &lt;context-param server-id="${'${'}server.name}"/&gt;

  &lt;web-app id="/"&gt;
    &lt;document-directory&gt;webapps/ROOT&lt;/document-directory&gt;
  &lt;/web-app&gt;
&lt;/host&gt;
</example>

<deftable title="Environment variables">
<tr><th>variable</th><th>attribute</th><th>meaning</th>
</tr><tr><td>Var</td><td>&#160;</td><td>System properties, e.g. ${'${'}Var["resin.home"]}

</td></tr><tr><td>server</td><td>&#160;</td><td>Server properties
</td></tr><tr><td>&#160;</td><td>id</td><td>The server id, as specified in -server id
</td></tr><tr><td>&#160;</td><td>rootDir</td><td>The server root directory

</td></tr><tr><td>host</td><td>&#160;</td><td>Virtual host properties
</td></tr><tr><td>&#160;</td><td>url</td><td>The host's canonical URL
</td></tr><tr><td>&#160;</td><td>name</td><td>The host name
</td></tr><tr><td>&#160;</td><td>rootDir</td><td>The host's root directory
</td></tr><tr><td>&#160;</td><td>warDir</td><td>The host's war directory
</td></tr><tr><td>&#160;</td><td>warExpandDir</td><td>The host's war expansion directory
</td></tr><tr><td>&#160;</td><td>regexp</td><td>Regular expression values for host regexp matches

</td></tr><tr><td>app</td><td>&#160;</td><td>web-app properties
</td></tr><tr><td>&#160;</td><td>url</td><td>The web-app's canonical URL
</td></tr><tr><td>&#160;</td><td>name</td><td>The web-app name
</td></tr><tr><td>&#160;</td><td>contextPath</td><td>The web-app's context path
</td></tr><tr><td>&#160;</td><td>docDir</td><td>The web-app's document directory
</td></tr><tr><td>&#160;</td><td>regexp</td><td>Regular expression values for web-app url-regexp matches
</td></tr></deftable>
</s1>

<s1 name="init" title="Servlet/Filter bean-style initialization" version="2.1.3">

<p>EL expressions can be used to configure servlets and
filters. <var>init-param</var> values can use JSP EL expressions, including the
ability to use system properties.

</p><p>Servlets, filters, and resources can be configured like beans with setter
methods are called directly (See <a href="doc|ioc-bean.xtp">Bean-style
init)</a>.</p>

<p>One example use use for the bean-style servlet initialization is to avoid
JNDI lookup inside the servlet code.  For example, a servlet that that uses a
JDBC DataSource might look like:</p>

<example title="Servlet using JDBC">
package test;

...

public class TestServlet extends HttpServlet {
  private DataSource _dataSource;

  /**
   * Bean setter is called to configure the servlet
   * before the init() method.
   */
  public void setDataSource(DataSource dataSource)
  {
    _dataSource = dataSource;
  }

  ...
}
</example>

<p>The servlet is configured as follows:</p>

<example title="Example configuration">
&lt;web-app&gt;
  &lt;allow-servlet-el/&gt;

  &lt;servlet servlet-name='test'
           servlet-class='test.TestServlet'&gt;
    &lt;init&gt;
      &lt;data-source&gt;${'${'}jndi:lookup("java:comp/env/jdbc/test")}&lt;/data-source&gt;
    &lt;/init&gt;
  &lt;/servlet&gt;

  ...
&lt;/web-app&gt;
</example>

<p>The <code>%lt;data-source%gt;</code> xml tag corresponds to the
<code>setDataSource</code> method of the bean.  More infomation on this
powerful pattern is in the <a href="doc|ioc-bean.xtp">Bean-style init</a>
section of the documentation.</p>
</s1> <!-- init -->

<s1 name="control" title="Control Structures" version="3.0.7">
<p>The resin.conf and web.xml configuration files can use
control structures.  The syntax of the control structures is deliberately similar to the control structures used in JSTL.  

</p><p>These can be useful to create a resin.conf which works for both testing and
deployment, depending on an environment parameter.
When possible, users should avoid using the control tags when possible
to keep their configuration files as simple as possible.</p>

<example>
&lt;web-app xmlns="http://caucho.com/ns/resin"
            xmlns:resin="http://caucho.com/ns/resin/core"&gt;
  &lt;resin:choose&gt;
  &lt;resin:when test="\${mode='development'}"&gt;
    &lt;resin:log&gt;Development Mode&lt;/resin:log&gt; 
  &lt;/resin:when&gt;
  &lt;resin:when test="\${mode='deploy'}"&gt;
    &lt;resin:log&gt;Deployment Mode&lt;/resin:log&gt; 
  &lt;/resin:when&gt;
  &lt;resin:otherwise&gt;
    &lt;resin:log&gt;Unknown Mode \${mode}&lt;/resin:log&gt;
  &lt;/resin:otherwise&gt;
  &lt;resin:choose&gt;
&lt;/web-app&gt;
</example>

<p>The source code for the control elements is found in 
<a href="javadoc|com.caucho.config.core|"/>.</p>

<s2 title="resin:set" version="Resin 3.0.7" type="defun">

<p>resin:set adds an EL variable to the current context.</p>

<def>
&lt;resin:set var="name" value="\${value}"/&gt;
</def>

<deftable-childtags>
<tr><td>name</td><td>name of the variable to set</td><td>required
</td></tr><tr><td>value</td><td>value</td><td>required
</td></tr></deftable-childtags>
</s2>

<s2 title="resin:if" version="Resin 3.0.7" type="defun">

<p>resin:if executes part of the configuration file conditionally.</p>

<def>
&lt;resin:if test="\${expr}"&gt;
  ...
&lt;resin:if&gt;
</def>

<deftable-childtags>
<tr><td>test</td><td>the test to perform
</td></tr></deftable-childtags>
</s2>

<s2 title="resin:choose" version="Resin 3.0.7" type="defun">

<p>resin:choose implements an if, elsif, else.</p>

<def>
&lt;resin:choose&gt;
  &lt;resin:when test="\${expr1}"&gt;
    ...
  &lt;/resin:when&gt;

  &lt;resin:when test="\${expr2}"&gt;
    ...
  &lt;/resin:when&gt;

  &lt;resin:otherwise&gt;
    ...
  &lt;/resin:otherwise&gt;
&lt;resin:choose&gt;
</def>

<deftable-childtags>
<tr><td>resin:when</td><td>
</td></tr><tr><td>resin:choose</td><td>
</td></tr></deftable-childtags>

<s3 title="resin:when" version="Resin 3.0.7" type="defun">
<parents>resin:choose</parents>
<deftable-childtags>
<tr><td>test</td><td>the test to perform
</td></tr></deftable-childtags>
</s3>

<s3 title="resin:otherwise" version="Resin 3.0.7" type="defun">
<parents>resin:choose</parents>
<deftable-childtags>
<tr><td>test</td><td>the test to perform
</td></tr></deftable-childtags>
</s3>
</s2> <!-- resin:choose -->

<s2 title="resin:log" version="Resin 3.0.7" type="defun">

<p>Logs a message to the given log file. The content of the element is the
message.</p>

<example>
  &lt;resin:log&gt;Starting server \${server.name}&lt;/resin:log&gt;
</example>
</s2>

<s2 title="resin:import" version="Resin 3.0.7" type="defun">

<p>resin:import is used to read configuration information from another file.
The target file is validated by a schema where the schema depends on the
location of the resin:import.
A resin:import in &lt;server&gt; will have a target with a top-level
of &lt;server&gt;.
</p>

<deftable-childtags>
<tr><td>path</td><td>a path to a file</td><td>either path or fileset is required
</td></tr><tr><td>fileset</td><td>a <a config-tag="fileset"/></td><td>either path or fileset is required
</td></tr><tr><td>optional</td><td>if true, no error when file does not exist</td><td>false
</td></tr></deftable-childtags>


</s2>

<s2 title="resin:env" version="Resin 3.0.7" type="defun">

<p>resin:env creates a new environment for a section of the
configuration file.  Some users may want to use this to create resources
or databases with custom &lt;class-loader&gt; tags.</p>

<p>resin:env is tricky and only required for some extraordinary circumstances.
Using it correctly requires a good understanding of classloaders.</p>

<p>Here is an example of a solution for the situation where a custom access
logging class requires an old version of a jar that the web application uses as
well.  The requirement is that the <code>example.MyAccessLog</code> use an old
version of the classes in Foo.jar, webapps use a newer version of the jar.</p>

<p>In a normal circumstance, <code>access-log</code> is used in the &lt;host&gt;
environment.  If the <code>example.MyAccessLog</code> uses a class from a jar
file <code>oldversion-Foo.jar</code>, <code>oldversion-Foo.jar</code> needs to
available to the classloader for the &lt;host&gt; environment.  Because a
%lt;web-app&gt; inherits the
classes of the &lt;host&gt;, the webapp will end up with the
<code>Foo.jar</code> classes from the host's classloader;
<code>WEB-INF/lib/Foo.jar</code> will not provide the classes because they have
already been defined in the parent (host) classloader.</p>

<p>The following example solves the problem by using <code>resin:env</code> to
create an environment just for the instantiation of the
<code>example.MyAccessLog</code> class.</p>

<example>
&lt;host id=''&gt;
  &lt;resin:env&gt;
   &lt;class-loader&gt;
     &lt;library-loader path="/opt/lib/oldversion-Foo.jar"/&gt;
   &lt;/class-loader&gt;

   &lt;access-log resin:type="example.MyAccessLog"/&gt;
  &lt;/resin:env&gt;

  ...

  &lt;web-app&gt;
    &lt;!-- WEB-INF/lib can contain Foo.jar and the classes are not overridden 
         by the classes in oldversion-Foo.jar.
       --&gt;
    ...
  &lt;/web-app&gt;
&lt;/host&gt;
</example>

</s2>

</s1> <!-- control -->


<s1 name="functions" title="Functions">

<p>Static functions are available in EL expressions.  Resin also makes utility
objects avilable as EL variables that provide functions as methods.</p>

<s2 title="jndi">

<s3 title="jndi:lookup" type="defun">

<p>The configuration EL supports a the static function jndi:lookup.
jndi:lookup can be used to lookup a JNDI value for the configuration.</p>

<example title="configuring JNDI">
&lt;servlet servlet-name='foo'
         servlet-class='qa.FooServlet'&gt;
  &lt;init&gt;
    &lt;data-source&gt;${'${'}jndi:lookup("java:comp/env/jdbc/test")}&lt;/data-source&gt;
  &lt;/init&gt;
&lt;/servlet&gt;
</example>
</s3> <!-- jndi:lookup -->
</s2> <!-- jndi -->

<s2 title="fmt">

<p>The EL Environment contains a <var>fmt</var> object, which has a number of
useful formatting methods.</p>

<s3 title="fmt.timestamp()" type="defun">

<p>Format a timestamp string.</p>

<example>fmt.timestamp(format[,date])</example>

<deftable-parameters>
<tr><td>format</td><td>the format string (see below)</td><td>required
</td></tr><tr><td>date</td><td>an object with <a href="javadoc|java.util.Date|"/> or <a href="javadoc|java.util.Calendar|"/> or <a href="javadoc|com.caucho.util.QDate|"/></td><td>the current date and time
</td></tr></deftable-parameters>

<example>
msg="The current date and time is ${'${'}fmt.timestamp('%Y/%m/%d %H:%M:%S.%s')}"
msg="time=${'${'}fmt.timestamp('[%Y/%m/%d %H:%M:%S.%s]')}"
</example>

<p><code>format</code> contains regular characters, which are just copied to
the output string, and percent codes which are substituted with time and date
values.</p>

<deftable>
<tr><th>Code</th><th>Meaning
</th></tr><tr><td>%a</td><td>day of week (short)
</td></tr><tr><td>%A</td><td>day of week (verbose)
</td></tr><tr><td>%b</td><td>day of month (short)
</td></tr><tr><td>%B</td><td>day of month (verbose)
</td></tr><tr><td>%c</td><td>Java locale date
</td></tr><tr><td>%d</td><td>day of month (two-digit)
</td></tr><tr><td>%H</td><td>24-hour (two-digit)
</td></tr><tr><td>%I</td><td>12-hour (two-digit)
</td></tr><tr><td>%j</td><td>day of year (three-digit)
</td></tr><tr><td>%m</td><td>month (two-digit)
</td></tr><tr><td>%M</td><td>minutes
</td></tr><tr><td>%p</td><td>am/pm
</td></tr><tr><td>%S</td><td>seconds
</td></tr><tr><td>%s</td><td>milliseconds
</td></tr><tr><td>%W</td><td>week in year (three-digit)
</td></tr><tr><td>%w</td><td>day of week (one-digit)
</td></tr><tr><td>%y</td><td>year (two-digit)
</td></tr><tr><td>%Y</td><td>year (four-digit)
</td></tr><tr><td>%Z</td><td>time zone (name)
</td></tr><tr><td>%z</td><td>time zone (+/-0800)
</td></tr></deftable>

</s3> <!-- timestamp -->

<s3 title="fmt.sprintf()" type="defun">
<p>Format a string using a sprintf-like format string.</p>

<def>fmt.sprintf(format[,arg1, arg2 ... argN])</def>

<deftable-parameters>
<tr><td>format</td><td>the format string (see below)</td><td>required
</td></tr><tr><td>arg1..argN</td><td>the values used for the conversions in the format string</td><td>n/a
</td></tr></deftable-parameters>

<p><code>sprintf</code> accepts a series of arguments, applies to each a format 
specifier  from `format', and returns the formatted data as a string.
`format' is a string containing two types of objects:  ordinary
characters (other than `%'), which are copied unchanged to the output, and
conversion specifications, each of which is introduced by `%'. (To include
`%' in the output, use `%%' in the format string). </p>

<p>A conversion specification has the following form:</p>

<def>%[FLAGS][WIDTH][.PREC][TYPE]</def>

<p>TYPE is required, the rest are optional.</p>

<p>The following TYPE's are supported:</p>

<deftable>
<tr><td>%%</td><td>a percent sign
</td></tr><tr><td>%c</td><td>a character with the given number
</td></tr><tr><td>%s</td><td>a string, a null string becomes "#null"
</td></tr><tr><td>%z</td><td>a string, a null string becomes the empty string ""
</td></tr><tr><td>%d</td><td>a signed integer, in decimal
</td></tr><tr><td>%o</td><td>an integer, in octal
</td></tr><tr><td>%u</td><td>an integer, in decimal
</td></tr><tr><td>%x</td><td>an integer, in hexadecimal
</td></tr><tr><td>%X</td><td>an integer, in hexadecimal using upper-case letters
</td></tr><tr><td>%e</td><td>a floating-point number, in scientific notation
</td></tr><tr><td>%E</td><td>a floating-point number, like %e with an upper-case "E"
</td></tr><tr><td>%f</td><td>a floating-point number, in fixed decimal notation
</td></tr><tr><td>%g</td><td>a floating-point number, in %e or %f notation
</td></tr><tr><td>%G</td><td>a floating-point number, like %g with an upper-case "E"
</td></tr><tr><td>%p</td><td>a pointer (outputs a value like the default of toString())
</td></tr></deftable>

<p>Intepret the word `integer' to mean the java type long.  
Since java does not support unsigned integers, all integers are treated 
the same.</p>

<p>The following optional FLAGS are supported:</p>
<deftable>
<tr><td>0</td><td>If the TYPE character is an integer leading zeroes are used 
             to pad the field width instead of spaces (following any 
             indication of sign or base).

</td></tr><tr><td>+</td><td>Include a `+' with positive numbers.

</td></tr><tr><td>(a space)</td><td>use a space placeholder for the `+' that would result
                     from a positive number
</td></tr><tr><td>-</td><td>The result of is left justified, and the right is padded with
             blanks until the result is `WIDTH' in length.  If you do not 
             use this flag, the result is right justified, and padded on 
             the left.
</td></tr><tr><td>#</td><td>an alternate display is used, for `x' and `X' a
             non-zero result will have an "0x" prefix; for floating 
             point numbers the result will always contain a decimal point.

</td></tr><tr><td>j</td><td>escape a string suitable for a Java string, or a CSV file. 
             The following escapes are applied: " becomes \", 
             newline becomes \n, return becomes \r, \ becomes \\.

</td></tr><tr><td>v</td><td>escape a string suitable for CSV files, the same as `j'
             with an additional <code>"</code> placed at the beginning 
             and ending of the string

</td></tr><tr><td>m</td><td>escape a string suitable for a XML file.  The following
             escapes are applied: &lt; becomes &amp;lt;, 
             &gt; becomes &amp;gt; &amp; becomes &amp;amp;
             ' becomes &amp;#039, " becomes &amp;034;
</td></tr></deftable>

<p>The optional WIDTH argument specifies a minium width for the field.
Spaces are used unless the `0' FLAG was used to indicate 0 padding.</p>

<p>The optional PREC argument is introduced with a `.', and gives the 
maximum number of characters to print; or the minimum
number of digits to print for integer and hex values; or the maximum 
number of significant digits for `g' and `G'; or the number of digits 
to print after the decimal point for floating points.</p>

</s3> <!-- sprintf -->
</s2> <!-- util -->

</s1> <!-- functions -->



</body>
</document>